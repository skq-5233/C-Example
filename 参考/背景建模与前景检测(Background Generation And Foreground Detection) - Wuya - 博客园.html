<!DOCTYPE html>
<!-- saved from url=(0073)http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html -->
<html lang="zh-cn"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/ca-pub-4210569241504288.js"></script><script async="" src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/analytics.js"></script><script type="text/javascript" src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/encoder.js"></script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园</title>
<link type="text/css" rel="stylesheet" href="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/blog-common.css">
<link id="MainCss" type="text/css" rel="stylesheet" href="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/bundle-SimpleBlue.css">
<link id="mobile-style" media="only screen and (max-width: 768px)" type="text/css" rel="stylesheet" href="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/bundle-SimpleBlue-mobile.css">
<link title="RSS" type="application/rss+xml" rel="alternate" href="http://www.cnblogs.com/xrwang/rss">
<link title="RSD" type="application/rsd+xml" rel="EditURI" href="http://www.cnblogs.com/xrwang/rsd.xml">
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="http://www.cnblogs.com/xrwang/wlwmanifest.xml">
<script src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/jquery.js" type="text/javascript"></script>  
<script type="text/javascript">var currentBlogApp = 'xrwang', cb_enable_mathjax=false;var isLogined=false;</script>
<script src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/blog-common.js" type="text/javascript"></script>
</head>
<body>
<a name="top"></a>

<div id="home">
<div id="header">
	<div id="blogTitle">
		
<!--done-->
<div class="title"><a id="Header1_HeaderTitle" class="headermaintitle" href="http://www.cnblogs.com/xrwang/">无涯（C、.net、图像处理、算法）</a></div>
<div class="subtitle"></div>



		
	</div><!--end: blogTitle 博客的标题和副标题 -->
	<div id="navigator">
		
<ul id="navList">
<li id="nav_sitehome"><a id="blog_nav_sitehome" class="menu" href="http://www.cnblogs.com/">博客园</a></li>
<li id="nav_myhome"><a id="blog_nav_myhome" class="menu" href="http://www.cnblogs.com/xrwang/">首页</a></li>
<li id="nav_newpost"><a id="blog_nav_newpost" class="menu" rel="nofollow" href="https://i.cnblogs.com/EditPosts.aspx?opt=1">新随笔</a></li>
<li id="nav_contact"><a id="blog_nav_contact" class="menu" rel="nofollow" href="https://msg.cnblogs.com/send/Wuya">联系</a></li>
<li id="nav_rss"><a id="blog_nav_rss" class="menu" href="http://www.cnblogs.com/xrwang/rss">订阅</a>
<!--<a id="blog_nav_rss_image" class="aHeaderXML" href="http://www.cnblogs.com/xrwang/rss"><img src="//www.cnblogs.com/images/xml.gif" alt="订阅" /></a>--></li>
<li id="nav_admin"><a id="blog_nav_admin" class="menu" rel="nofollow" href="https://i.cnblogs.com/">管理</a></li>
</ul>

		<div class="blogStats">
			
			<div id="blog_stats">
<!--done-->
随笔-40&nbsp;
文章-0&nbsp;
评论-845&nbsp;
</div>
			
		</div><!--end: blogStats -->
	</div><!--end: navigator 博客导航栏 -->
</div><!--end: header 头部 -->
<div id="main">
	<div id="mainContent">
	<div class="forFlow">
		
<div id="post_detail">
<!--done-->
<div id="topics">
	<div class="post">
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2" href="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园.html">背景建模与前景检测(Background Generation And Foreground Detection)</a>
		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body"><p>作者：王先荣</p>
<p><b>前言<br></b>&nbsp;&nbsp;&nbsp; 在很多情况下，我们需要从一段视频或者一系列图片中找到感兴趣的目标，比如说当人进入已经打烊的超市时发出警报。为了达到这个目的，我们首先需要“学习”背景模型，然后将背景模型和当前图像进行比较，从而得到前景目标。</p>
<p><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/2010022123090775.png"></p>
<p><b>背景建模</b><br>&nbsp;&nbsp;&nbsp; 背景与前景都是相对的概念，以高速公路为例：有时我们对高速公路上来来往往的汽车感兴趣，这时汽车是前景，而路面以及周围的环境是背景；有时我们仅仅对闯入高速公路的行人感兴趣，这时闯入者是前景，而包括汽车之类的其他东西又成了背景。背景建模的方式很多，或高级或简单。不过各种背景模型都有自己适用的场合，即使是高级的背景模型也不能适用于任何场合。下面我将逐一介绍OpenCv中已经实现，或者在《学习OpenCv》这本书中介绍的背景建模方法。<br><b>1.帧差<br></b>&nbsp;&nbsp;&nbsp; 帧差可说是最简单的一种背景模型，指定视频中的一幅图像为背景，用当前帧与背景进行比较，根据需要过滤较小的差异，得到的结果就是前景了。OpenCv中为我们提供了一种动态计算阀值，然后用帧差进行前景检测的函数——cvChangeDetection（注：EmguCv中没有封装cvChangeDetection，我将其声明到OpenCvInvoke类中，具体实现见文末代码）。而通过对两幅图像使用减法运算，然后再用指定阀值过滤的方法在《学习OpenCv》一书中有详细的介绍。它们的实现代码如下：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show(&#39;3ca5a4f2-74e5-4d34-ab75-2544161f5845&#39;)"><img id="code_img_closed_3ca5a4f2-74e5-4d34-ab75-2544161f5845" class="code_img_closed" src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/ContractedBlock.gif" style="display: none;"><img style="" id="code_img_opened_3ca5a4f2-74e5-4d34-ab75-2544161f5845" class="code_img_opened" onclick="cnblogs_code_hide(&#39;3ca5a4f2-74e5-4d34-ab75-2544161f5845&#39;,event)" src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/ExpandedBlockStart.gif"><span class="cnblogs_code_collapse" style="display: none;">帧差</span>
<div id="cnblogs_code_open_3ca5a4f2-74e5-4d34-ab75-2544161f5845" class="cnblogs_code_hide" style="display: block;"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #000000;">            [DllImport(</span><span style="color: #800000;">"</span><span style="color: #800000;">cvaux200.dll</span><span style="color: #800000;">"</span><span style="color: #000000;">)]<br>            </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">extern</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> cvChangeDetection(IntPtr prev_frame, IntPtr curr_frame, IntPtr change_mask);<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">backgroundMask为背景，imageBackgroundModel为背景模型，currentFrame为当前帧</span><span style="color: #008000;"><br></span><span style="color: #000000;">            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (backgroundMask </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                backgroundMask </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, </span><span style="color: #0000ff;">byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(imageBackgroundModel.Size);<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (threshold </span><span style="color: #000000;">==</span><span style="color: #000000;"> 0d)<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">如果阀值为0，使用OpenCv中的自适应动态背景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">                OpenCvInvoke.cvChangeDetection(imageBackgroundModel.Ptr, currentFrame.Ptr, backgroundMask.Ptr);<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">如果设置了阀值，使用帧差</span><span style="color: #008000;"><br></span><span style="color: #000000;">                Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageTemp </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageBackgroundModel.AbsDiff(currentFrame);<br>                Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">[] images </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageTemp.Split();<br>                backgroundMask.SetValue(0d);<br>                </span><span style="color: #0000ff;">foreach</span><span style="color: #000000;"> (Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> image </span><span style="color: #0000ff;">in</span><span style="color: #000000;"> images)<br>                    backgroundMask._Or(image.ThresholdBinary(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Gray(threshold), </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Gray(255d)));<br>            }<br>            backgroundMask._Not();<br></span></div></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
</div>
<p>对于类似无人值守的仓库防盗之类的场合，使用帧差效果估计很好。</p>
<p><b>2.背景统计模型<br></b>&nbsp;&nbsp;&nbsp; 背景统计模型是：对一段时间的背景进行统计，然后计算其统计数据（例如平均值、平均差分、标准差、均值漂移值等等），将统计数据作为背景的方法。OpenCv中并未实现简单的背景统计模型，不过在《学习OpenCv》中对其中的平均背景统计模型有很详细的介绍。在模仿该算法的基础上，我实现了一系列的背景统计模型，包括：平均背景、均值漂移、标准差和标准协方差。对这些统计概念我其实不明白，在维基百科上看了好半天 -_-<br>调用背景统计模型很简单，只需4步而已：</p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #008000;">//</span><span style="color: #008000;">(1)初始化对象</span><span style="color: #008000;"><br></span><span style="color: #000000;">BackgroundStatModelBase</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> bgModel </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> BackgroundStatModelBase</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(BackgroundStatModelType.AccAvg);<br></span><span style="color: #008000;">//</span><span style="color: #008000;">(2)更新一段时间的背景图像，视情况反复调用(2)</span><span style="color: #008000;"><br></span><span style="color: #000000;">bgModel.Update(image);<br></span><span style="color: #008000;">//</span><span style="color: #008000;">(3)设置当前帧</span><span style="color: #008000;"><br></span><span style="color: #000000;">bgModel.CurrentFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> currentFrame;<br></span><span style="color: #008000;">//</span><span style="color: #008000;">(4)得到背景或者前景</span><span style="color: #008000;"><br></span><span style="color: #000000;">Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray,Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageForeground </span><span style="color: #000000;">=</span><span style="color: #000000;"> bgModel.ForegroundMask;<br></span></div></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>背景统计模型的实现代码如下：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show(&#39;f1e3f5eb-1246-4cd5-b9b6-fc99bb7fa444&#39;)"><img id="code_img_closed_f1e3f5eb-1246-4cd5-b9b6-fc99bb7fa444" class="code_img_closed" src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/ContractedBlock.gif" style="display: none;"><img style="" id="code_img_opened_f1e3f5eb-1246-4cd5-b9b6-fc99bb7fa444" class="code_img_opened" onclick="cnblogs_code_hide(&#39;f1e3f5eb-1246-4cd5-b9b6-fc99bb7fa444&#39;,event)" src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/ExpandedBlockStart.gif"><span class="cnblogs_code_collapse" style="display: none;">实现背景统计模型</span>
<div id="cnblogs_code_open_f1e3f5eb-1246-4cd5-b9b6-fc99bb7fa444" class="cnblogs_code_hide" style="display: block;"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #008000;">/*</span><span style="color: #008000;"><br>背景统计模型<br>作者：王先荣<br>时间：2010年2月19日<br></span><span style="color: #008000;">*/</span><span style="color: #000000;"><br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Collections.Generic;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Linq;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Text;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Drawing;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Diagnostics;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Runtime.InteropServices;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> Emgu.CV;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> Emgu.CV.CvEnum;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> Emgu.CV.Structure;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> Emgu.CV.UI;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> Emgu.CV.VideoSurveillance;<br><br></span><span style="color: #0000ff;">namespace</span><span style="color: #000000;"> ImageProcessLearn<br>{<br>    </span><span style="color: #008000;">//</span><span style="color: #008000;">背景模型接口，在IBGFGDetector接口的基础上增加了一个CurrentFrame属性</span><span style="color: #008000;"><br></span><span style="color: #000000;">    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">interface</span><span style="color: #000000;"> IBackgroundStatModel</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> : IDisposable<br>        </span><span style="color: #0000ff;">where</span><span style="color: #000000;"> TColor : </span><span style="color: #0000ff;">struct</span><span style="color: #000000;">, IColor<br>    {<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取前景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, </span><span style="color: #0000ff;">byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> BackgroundMask { </span><span style="color: #0000ff;">get</span><span style="color: #000000;">; }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取背景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, </span><span style="color: #0000ff;">byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> ForegroundMask { </span><span style="color: #0000ff;">get</span><span style="color: #000000;">; }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 更新背景模型<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;param name="image"&gt;&lt;/param&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> Update(Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, </span><span style="color: #0000ff;">byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> image);<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 计算统计数据<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> CalcStatData();<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取或者设置当前帧<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> CurrentFrame<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;">;<br>            </span><span style="color: #0000ff;">set</span><span style="color: #000000;">;<br>        }<br>    }<br><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> 使用帧差的方式来建立背景模型<br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #008000;"><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;typeparam name="TColor"&gt;&lt;/typeparam&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">class</span><span style="color: #000000;"> BackgroundStatModelFrameDiff</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> : IBackgroundStatModel</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"><br>        </span><span style="color: #0000ff;">where</span><span style="color: #000000;"> TColor : </span><span style="color: #0000ff;">struct</span><span style="color: #000000;">, IColor<br>    {<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">成员</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageBackgroundModel;   </span><span style="color: #008000;">//</span><span style="color: #008000;">背景模型图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> currentFrame;           </span><span style="color: #008000;">//</span><span style="color: #008000;">当前帧</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">double</span><span style="color: #000000;"> threshold;                           </span><span style="color: #008000;">//</span><span style="color: #008000;">计算前景时所用的阀值，如果当前帧和背景的差别大于阀值，则被认为是前景</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> backgroundMask;           </span><span style="color: #008000;">//</span><span style="color: #008000;">计算得到的背景图像</span><span style="color: #008000;"><br></span><span style="color: #000000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 构造函数<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;param name="image"&gt;</span><span style="color: #008000;">用于背景统计模型的背景</span><span style="color: #808080;">&lt;/param&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> BackgroundStatModelFrameDiff(Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> image)<br>        {<br>            imageBackgroundModel </span><span style="color: #000000;">=</span><span style="color: #000000;"> image;<br>            currentFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            threshold </span><span style="color: #000000;">=</span><span style="color: #000000;"> 15d;<br>            backgroundMask </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>        }<br><br>        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> BackgroundStatModelFrameDiff()<br>            : </span><span style="color: #0000ff;">this</span><span style="color: #000000;">(</span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>        {<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 设置或者获取计算前景时所用的阀值；如果阀值为0，则使用自适应的阀值<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">double</span><span style="color: #000000;"> Threshold<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> threshold;<br>            }<br>            </span><span style="color: #0000ff;">set</span><span style="color: #000000;"><br>            {<br>                threshold </span><span style="color: #000000;">=</span><span style="color: #000000;"> value </span><span style="color: #000000;">&gt;=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;"> </span><span style="color: #000000;">?</span><span style="color: #000000;"> value : 15d;<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 更新背景模型<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;param name="image"&gt;&lt;/param&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> Update(Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> image)<br>        {<br>            imageBackgroundModel </span><span style="color: #000000;">=</span><span style="color: #000000;"> image;<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取或者设置当前帧<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> CurrentFrame<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> currentFrame;<br>            }<br>            </span><span style="color: #0000ff;">set</span><span style="color: #000000;"><br>            {<br>                currentFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> value;<br>                CalcBackgroundMask();<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 计算统计数据<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> CalcStatData()<br>        {<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 计算背景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> CalcBackgroundMask()<br>        {<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (imageBackgroundModel </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;"> </span><span style="color: #000000;">||</span><span style="color: #000000;"> currentFrame </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;"> </span><span style="color: #000000;">||</span><span style="color: #000000;"> imageBackgroundModel.Size </span><span style="color: #000000;">!=</span><span style="color: #000000;"> currentFrame.Size)<br>                </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> ArgumentException(</span><span style="color: #800000;">"</span><span style="color: #800000;">在计算背景时发现参数错误。可能是：背景模型图像为空，当前帧为空，或者背景模型图像和当前帧的尺寸不一致。</span><span style="color: #800000;">"</span><span style="color: #000000;">);<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (backgroundMask </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                backgroundMask </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, </span><span style="color: #0000ff;">byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(imageBackgroundModel.Size);<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (threshold </span><span style="color: #000000;">==</span><span style="color: #000000;"> 0d)<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">如果阀值为0，使用OpenCv中的自适应动态背景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">                OpenCvInvoke.cvChangeDetection(imageBackgroundModel.Ptr, currentFrame.Ptr, backgroundMask.Ptr);<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">如果设置了阀值，使用帧差</span><span style="color: #008000;"><br></span><span style="color: #000000;">                Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageTemp </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageBackgroundModel.AbsDiff(currentFrame);<br>                Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">[] images </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageTemp.Split();<br>                backgroundMask.SetValue(0d);<br>                </span><span style="color: #0000ff;">foreach</span><span style="color: #000000;"> (Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> image </span><span style="color: #0000ff;">in</span><span style="color: #000000;"> images)<br>                    backgroundMask._Or(image.ThresholdBinary(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Gray(threshold), </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Gray(255d)));<br>            }<br>            backgroundMask._Not();<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取背景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> BackgroundMask<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> backgroundMask;<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取前景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> ForegroundMask<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> backgroundMask.Not();<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 释放资源<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> Dispose()<br>        {<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (backgroundMask </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                backgroundMask.Dispose();<br>        }<br>    }<br><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> 使用平均背景来建立背景模型<br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #008000;"><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;typeparam name="TColor"&gt;&lt;/typeparam&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">class</span><span style="color: #000000;"> BackgroundStatModelAccAvg</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> : IBackgroundStatModel</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"><br>        </span><span style="color: #0000ff;">where</span><span style="color: #000000;"> TColor : </span><span style="color: #0000ff;">struct</span><span style="color: #000000;">, IColor<br>    {<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">成员</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageAccSum;          </span><span style="color: #008000;">//</span><span style="color: #008000;">累计图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageAccDiff;         </span><span style="color: #008000;">//</span><span style="color: #008000;">累计差值图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> frameCount;                             </span><span style="color: #008000;">//</span><span style="color: #008000;">已经累计的背景帧数</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> previousFrame;        </span><span style="color: #008000;">//</span><span style="color: #008000;">在背景建模时使用的前一帧图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> currentFrame;           </span><span style="color: #008000;">//</span><span style="color: #008000;">当前帧图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">double</span><span style="color: #000000;"> scale;                               </span><span style="color: #008000;">//</span><span style="color: #008000;">计算背景时所使用的缩放系数，大于平均值*scale倍数的像素认为是前景</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> backgroundMask;           </span><span style="color: #008000;">//</span><span style="color: #008000;">计算得到的背景图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageTemp;            </span><span style="color: #008000;">//</span><span style="color: #008000;">临时图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isStatDataReady;                       </span><span style="color: #008000;">//</span><span style="color: #008000;">是否已经准备好统计数据</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">[] imagesHi;             </span><span style="color: #008000;">//</span><span style="color: #008000;">背景模型中各通道的最大值图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">[] imagesLow;            </span><span style="color: #008000;">//</span><span style="color: #008000;">背景模型中各通道的最小值图像</span><span style="color: #008000;"><br></span><span style="color: #000000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 构造函数<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> BackgroundStatModelAccAvg()<br>        {<br>            imageAccSum </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            imageAccDiff </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            frameCount </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">;<br>            previousFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            currentFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            scale </span><span style="color: #000000;">=</span><span style="color: #000000;"> 6d;<br>            backgroundMask </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            isStatDataReady </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>            imagesHi </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            imagesLow </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 设置或者获取计算前景时所用的阀值<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">double</span><span style="color: #000000;"> Scale<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> scale;<br>            }<br>            </span><span style="color: #0000ff;">set</span><span style="color: #000000;"><br>            {<br>                scale </span><span style="color: #000000;">=</span><span style="color: #000000;"> value </span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;"> </span><span style="color: #000000;">?</span><span style="color: #000000;"> value : 6d;<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 更新背景模型<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;param name="image"&gt;&lt;/param&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> Update(Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> image)<br>        {<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (frameCount</span><span style="color: #000000;">==</span><span style="color: #800080;">0</span><span style="color: #000000;">)<br>            {<br>                imageAccSum </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(image.Size);<br>                imageAccSum.SetValue(0d);<br>                imageAccDiff </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, </span><span style="color: #0000ff;">float</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(image.Size);<br>                imageAccDiff.SetValue(0d);<br>            }<br>            imageTemp </span><span style="color: #000000;">=</span><span style="color: #000000;"> image.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(1d, 0d); </span><span style="color: #008000;">//</span><span style="color: #008000;">将图像转换成浮点型</span><span style="color: #008000;"><br></span><span style="color: #000000;">            imageAccSum.Acc(imageTemp);<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (previousFrame </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                imageAccDiff.Acc(imageTemp.AbsDiff(previousFrame));<br>            previousFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageTemp.Copy();<br>            frameCount</span><span style="color: #000000;">++</span><span style="color: #000000;">;<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取或者设置当前帧<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> CurrentFrame<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> currentFrame;<br>            }<br>            </span><span style="color: #0000ff;">set</span><span style="color: #000000;"><br>            {<br>                currentFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> value;<br>                CalcBackgroundMask();<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 计算统计数据<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> CalcStatData()<br>        {<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">计算出最高及最低阀值图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageAvg </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageAccSum.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(1d </span><span style="color: #000000;">/</span><span style="color: #000000;"> frameCount, 0d);<br>            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageAvgDiff </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageAccDiff.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(1d </span><span style="color: #000000;">/</span><span style="color: #000000;"> frameCount, 1d);    </span><span style="color: #008000;">//</span><span style="color: #008000;">将平均值加1，为了确保总是存在差异</span><span style="color: #008000;"><br></span><span style="color: #000000;">            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageHi </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageAvg.Add(imageAvgDiff.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(scale, 0d));<br>            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageLow </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageAvg.Sub(imageAvgDiff.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(scale, 0d));<br>            imagesHi </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageHi.Split();<br>            imagesLow </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageLow.Split();<br>            isStatDataReady </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">释放资源</span><span style="color: #008000;"><br></span><span style="color: #000000;">            imageAvg.Dispose();<br>            imageAvgDiff.Dispose();<br>            imageHi.Dispose();<br>            imageLow.Dispose();<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 计算背景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> CalcBackgroundMask()<br>        {<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (imageAccSum </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;"> </span><span style="color: #000000;">||</span><span style="color: #000000;"> imageAccDiff </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;"> </span><span style="color: #000000;">||</span><span style="color: #000000;"> imageAccSum.Size </span><span style="color: #000000;">!=</span><span style="color: #000000;"> currentFrame.Size)<br>                </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> ArgumentException(</span><span style="color: #800000;">"</span><span style="color: #800000;">在计算背景时发生参数错误。可能是：还没有建立背景模型；或者当前帧的尺寸与背景尺寸不一致。</span><span style="color: #800000;">"</span><span style="color: #000000;">);<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (</span><span style="color: #000000;">!</span><span style="color: #000000;">isStatDataReady)<br>                CalcStatData();<br>            imageTemp </span><span style="color: #000000;">=</span><span style="color: #000000;"> currentFrame.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(1d, 0d);<br>            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">[] images </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageTemp.Split();<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">计算背景图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (backgroundMask </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                backgroundMask </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, </span><span style="color: #0000ff;">byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(currentFrame.Size);<br>            backgroundMask.SetZero();<br>            </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">int</span><span style="color: #000000;"> i </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">; i </span><span style="color: #000000;">&lt;</span><span style="color: #000000;"> currentFrame.NumberOfChannels; i</span><span style="color: #000000;">++</span><span style="color: #000000;">)<br>                backgroundMask._Or(images[i].InRange(imagesLow[i], imagesHi[i]));<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">释放资源</span><span style="color: #008000;"><br></span><span style="color: #000000;">            </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">int</span><span style="color: #000000;"> i </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">; i </span><span style="color: #000000;">&lt;</span><span style="color: #000000;"> images.Length; i</span><span style="color: #000000;">++</span><span style="color: #000000;">)<br>                images[i].Dispose();<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取背景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> BackgroundMask<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> backgroundMask;<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取前景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> ForegroundMask<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> backgroundMask.Not();<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 释放资源<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> Dispose()<br>        {<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (imageAccSum </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                imageAccSum.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (imageAccDiff </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                imageAccDiff.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (previousFrame </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                previousFrame.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (currentFrame </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                currentFrame.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (backgroundMask </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                backgroundMask.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isStatDataReady)<br>            {<br>                </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">int</span><span style="color: #000000;"> i </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">; i </span><span style="color: #000000;">&lt;</span><span style="color: #000000;"> imagesHi.Length; i</span><span style="color: #000000;">++</span><span style="color: #000000;">)<br>                {<br>                    imagesHi[i].Dispose();<br>                    imagesLow[i].Dispose();<br>                }<br>            }<br>        }<br>    }<br><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> 使用均值漂移来建立背景模型<br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #008000;"><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;typeparam name="TColor"&gt;&lt;/typeparam&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">class</span><span style="color: #000000;"> BackgroundStatModelRunningAvg</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> : IBackgroundStatModel</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"><br>        </span><span style="color: #0000ff;">where</span><span style="color: #000000;"> TColor : </span><span style="color: #0000ff;">struct</span><span style="color: #000000;">, IColor<br>    {<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">成员</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageAcc;             </span><span style="color: #008000;">//</span><span style="color: #008000;">累计图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageAccDiff;         </span><span style="color: #008000;">//</span><span style="color: #008000;">累计差值图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> frameCount;                             </span><span style="color: #008000;">//</span><span style="color: #008000;">已经累计的背景帧数</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> previousFrame;        </span><span style="color: #008000;">//</span><span style="color: #008000;">在背景建模时使用的前一帧图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> currentFrame;           </span><span style="color: #008000;">//</span><span style="color: #008000;">当前帧图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">double</span><span style="color: #000000;"> scale;                               </span><span style="color: #008000;">//</span><span style="color: #008000;">计算背景时所使用的缩放系数，大于平均值*scale倍数的像素认为是前景</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">double</span><span style="color: #000000;"> alpha;                               </span><span style="color: #008000;">//</span><span style="color: #008000;">计算均值漂移时使用的权值</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> backgroundMask;           </span><span style="color: #008000;">//</span><span style="color: #008000;">计算得到的背景图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageTemp;            </span><span style="color: #008000;">//</span><span style="color: #008000;">临时图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isStatDataReady;                       </span><span style="color: #008000;">//</span><span style="color: #008000;">是否已经准备好统计数据</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">[] imagesHi;             </span><span style="color: #008000;">//</span><span style="color: #008000;">背景模型中各通道的最大值图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">[] imagesLow;            </span><span style="color: #008000;">//</span><span style="color: #008000;">背景模型中各通道的最小值图像</span><span style="color: #008000;"><br></span><span style="color: #000000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 构造函数<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> BackgroundStatModelRunningAvg()<br>        {<br>            imageAcc </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            imageAccDiff </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            frameCount </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">;<br>            previousFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            currentFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            scale </span><span style="color: #000000;">=</span><span style="color: #000000;"> 6d;<br>            alpha </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0.5d</span><span style="color: #000000;">;<br>            backgroundMask </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            isStatDataReady </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>            imagesHi </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            imagesLow </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 设置或者获取计算前景时所用的阀值<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">double</span><span style="color: #000000;"> Scale<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> scale;<br>            }<br>            </span><span style="color: #0000ff;">set</span><span style="color: #000000;"><br>            {<br>                scale </span><span style="color: #000000;">=</span><span style="color: #000000;"> value </span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;"> </span><span style="color: #000000;">?</span><span style="color: #000000;"> value : 6d;<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 设置或者获取计算均值漂移是使用的权值<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">double</span><span style="color: #000000;"> Alpha<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> alpha;<br>            }<br>            </span><span style="color: #0000ff;">set</span><span style="color: #000000;"><br>            {<br>                alpha </span><span style="color: #000000;">=</span><span style="color: #000000;"> value </span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;"> </span><span style="color: #000000;">&amp;&amp;</span><span style="color: #000000;"> value </span><span style="color: #000000;">&lt;</span><span style="color: #000000;"> </span><span style="color: #800080;">1</span><span style="color: #000000;"> </span><span style="color: #000000;">?</span><span style="color: #000000;"> value : </span><span style="color: #800080;">0.5d</span><span style="color: #000000;">;<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 更新背景模型<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;param name="image"&gt;&lt;/param&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> Update(Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> image)<br>        {<br>            imageTemp </span><span style="color: #000000;">=</span><span style="color: #000000;"> image.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(1d, 0d); </span><span style="color: #008000;">//</span><span style="color: #008000;">将图像转换成浮点型</span><span style="color: #008000;"><br></span><span style="color: #000000;">            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (imageAcc </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>            {<br>                imageAcc </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageTemp.Copy();<br>            }<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"><br>                imageAcc.RunningAvg(imageTemp, alpha);<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (previousFrame </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>            {<br>                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (imageAccDiff </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                    imageAccDiff </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageTemp.AbsDiff(previousFrame);<br>                </span><span style="color: #0000ff;">else</span><span style="color: #000000;"><br>                    imageAccDiff.RunningAvg(imageTemp.AbsDiff(previousFrame), alpha);<br>            }<br>            previousFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageTemp.Copy();<br>            frameCount</span><span style="color: #000000;">++</span><span style="color: #000000;">;<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取或者设置当前帧<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> CurrentFrame<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> currentFrame;<br>            }<br>            </span><span style="color: #0000ff;">set</span><span style="color: #000000;"><br>            {<br>                currentFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> value;<br>                CalcBackgroundMask();<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 计算统计数据<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> CalcStatData()<br>        {<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">计算出最高及最低阀值图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageHi </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageAcc.Add(imageAccDiff.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(scale, 0d));<br>            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageLow </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageAcc.Sub(imageAccDiff.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(scale, 0d));<br>            imagesHi </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageHi.Split();<br>            imagesLow </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageLow.Split();<br>            isStatDataReady </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">释放资源</span><span style="color: #008000;"><br></span><span style="color: #000000;">            imageHi.Dispose();<br>            imageLow.Dispose();<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 计算背景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> CalcBackgroundMask()<br>        {<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (imageAcc </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;"> </span><span style="color: #000000;">||</span><span style="color: #000000;"> imageAccDiff </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;"> </span><span style="color: #000000;">||</span><span style="color: #000000;"> imageAcc.Size </span><span style="color: #000000;">!=</span><span style="color: #000000;"> currentFrame.Size)<br>                </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> ArgumentException(</span><span style="color: #800000;">"</span><span style="color: #800000;">在计算背景时发生参数错误。可能是：还没有建立背景模型；或者当前帧的尺寸与背景尺寸不一致。</span><span style="color: #800000;">"</span><span style="color: #000000;">);<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (</span><span style="color: #000000;">!</span><span style="color: #000000;">isStatDataReady)<br>                CalcStatData();<br>            imageTemp </span><span style="color: #000000;">=</span><span style="color: #000000;"> currentFrame.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(1d, 0d);<br>            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">[] images </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageTemp.Split();<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">计算背景图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (backgroundMask </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                backgroundMask </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, </span><span style="color: #0000ff;">byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(currentFrame.Size);<br>            backgroundMask.SetZero();<br>            </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">int</span><span style="color: #000000;"> i </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">; i </span><span style="color: #000000;">&lt;</span><span style="color: #000000;"> currentFrame.NumberOfChannels; i</span><span style="color: #000000;">++</span><span style="color: #000000;">)<br>                backgroundMask._Or(images[i].InRange(imagesLow[i], imagesHi[i]));<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">释放资源</span><span style="color: #008000;"><br></span><span style="color: #000000;">            </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">int</span><span style="color: #000000;"> i </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">; i </span><span style="color: #000000;">&lt;</span><span style="color: #000000;"> images.Length; i</span><span style="color: #000000;">++</span><span style="color: #000000;">)<br>                images[i].Dispose();<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取背景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> BackgroundMask<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> backgroundMask;<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取前景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> ForegroundMask<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> backgroundMask.Not();<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 释放资源<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> Dispose()<br>        {<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (imageAcc </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                imageAcc.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (imageAccDiff </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                imageAccDiff.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (previousFrame </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                previousFrame.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (currentFrame </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                currentFrame.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (backgroundMask </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                backgroundMask.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isStatDataReady)<br>            {<br>                </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">int</span><span style="color: #000000;"> i </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">; i </span><span style="color: #000000;">&lt;</span><span style="color: #000000;"> imagesHi.Length; i</span><span style="color: #000000;">++</span><span style="color: #000000;">)<br>                {<br>                    imagesHi[i].Dispose();<br>                    imagesLow[i].Dispose();<br>                }<br>            }<br>        }<br>    }<br><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> 使用标准方差来建立背景模型<br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #008000;"><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;typeparam name="TColor"&gt;&lt;/typeparam&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">class</span><span style="color: #000000;"> BackgroundStatModelSquareAcc</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> : IBackgroundStatModel</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"><br>        </span><span style="color: #0000ff;">where</span><span style="color: #000000;"> TColor : </span><span style="color: #0000ff;">struct</span><span style="color: #000000;">, IColor<br>    {<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">成员</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageAccSum;          </span><span style="color: #008000;">//</span><span style="color: #008000;">累计图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageAccSquare;       </span><span style="color: #008000;">//</span><span style="color: #008000;">累计平方图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> frameCount;                             </span><span style="color: #008000;">//</span><span style="color: #008000;">已经累计的背景帧数</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> previousFrame;        </span><span style="color: #008000;">//</span><span style="color: #008000;">在背景建模时使用的前一帧图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> currentFrame;           </span><span style="color: #008000;">//</span><span style="color: #008000;">当前帧图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">double</span><span style="color: #000000;"> scale;                               </span><span style="color: #008000;">//</span><span style="color: #008000;">计算背景时所使用的缩放系数，大于平均值*scale倍数的像素认为是前景</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> backgroundMask;           </span><span style="color: #008000;">//</span><span style="color: #008000;">计算得到的背景图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageTemp;            </span><span style="color: #008000;">//</span><span style="color: #008000;">临时图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isStatDataReady;                       </span><span style="color: #008000;">//</span><span style="color: #008000;">是否已经准备好统计数据</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">[] imagesHi;             </span><span style="color: #008000;">//</span><span style="color: #008000;">背景模型中各通道的最大值图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">[] imagesLow;            </span><span style="color: #008000;">//</span><span style="color: #008000;">背景模型中各通道的最小值图像</span><span style="color: #008000;"><br></span><span style="color: #000000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 构造函数<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> BackgroundStatModelSquareAcc()<br>        {<br>            imageAccSum </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            imageAccSquare </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            frameCount </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">;<br>            previousFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            currentFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            scale </span><span style="color: #000000;">=</span><span style="color: #000000;"> 6d;<br>            backgroundMask </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            isStatDataReady </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>            imagesHi </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            imagesLow </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 设置或者获取计算前景时所用的阀值<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">double</span><span style="color: #000000;"> Scale<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> scale;<br>            }<br>            </span><span style="color: #0000ff;">set</span><span style="color: #000000;"><br>            {<br>                scale </span><span style="color: #000000;">=</span><span style="color: #000000;"> value </span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;"> </span><span style="color: #000000;">?</span><span style="color: #000000;"> value : 6d;<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 更新背景模型<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;param name="image"&gt;&lt;/param&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> Update(Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> image)<br>        {<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (frameCount </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">)<br>            {<br>                imageAccSum </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(image.Size);<br>                imageAccSum.SetZero();<br>                imageAccSquare </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, </span><span style="color: #0000ff;">float</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(image.Size);<br>                imageAccSquare.SetZero();<br>            }<br>            imageTemp </span><span style="color: #000000;">=</span><span style="color: #000000;"> image.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(1d, 0d); </span><span style="color: #008000;">//</span><span style="color: #008000;">将图像转换成浮点型</span><span style="color: #008000;"><br></span><span style="color: #000000;">            imageAccSum.Acc(imageTemp);<br>            CvInvoke.cvSquareAcc(imageTemp.Ptr, imageAccSquare.Ptr, IntPtr.Zero);<br>            previousFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageTemp.Copy();<br>            frameCount</span><span style="color: #000000;">++</span><span style="color: #000000;">;<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取或者设置当前帧<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> CurrentFrame<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> currentFrame;<br>            }<br>            </span><span style="color: #0000ff;">set</span><span style="color: #000000;"><br>            {<br>                currentFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> value;<br>                CalcBackgroundMask();<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 计算统计数据<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> CalcStatData()<br>        {<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">计算出标准差、最高及最低阀值图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageAvg </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageAccSum.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(1d </span><span style="color: #000000;">/</span><span style="color: #000000;"> frameCount, 0d);<br>            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageSd </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageAccSquare.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(1d </span><span style="color: #000000;">/</span><span style="color: #000000;"> frameCount, 0d);<br>            imageSd.Sub(imageAvg.Pow(2d));<br>            imageSd </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageSd.Pow(</span><span style="color: #800080;">0.5d</span><span style="color: #000000;">);<br>            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageHi </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageAvg.Add(imageSd.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(scale, 0d));<br>            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageLow </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageAvg.Sub(imageSd.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(scale, 0d));<br>            imagesHi </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageHi.Split();<br>            imagesLow </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageLow.Split();<br>            isStatDataReady </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">释放资源</span><span style="color: #008000;"><br></span><span style="color: #000000;">            imageAvg.Dispose();<br>            imageSd.Dispose();<br>            imageHi.Dispose();<br>            imageLow.Dispose();<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 计算背景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> CalcBackgroundMask()<br>        {<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (imageAccSum </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;"> </span><span style="color: #000000;">||</span><span style="color: #000000;"> imageAccSquare </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;"> </span><span style="color: #000000;">||</span><span style="color: #000000;"> imageAccSum.Size </span><span style="color: #000000;">!=</span><span style="color: #000000;"> currentFrame.Size)<br>                </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> ArgumentException(</span><span style="color: #800000;">"</span><span style="color: #800000;">在计算背景时发生参数错误。可能是：还没有建立背景模型；或者当前帧的尺寸与背景尺寸不一致。</span><span style="color: #800000;">"</span><span style="color: #000000;">);<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (</span><span style="color: #000000;">!</span><span style="color: #000000;">isStatDataReady)<br>                CalcStatData();<br>            imageTemp </span><span style="color: #000000;">=</span><span style="color: #000000;"> currentFrame.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(1d, 0d);<br>            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">[] images </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageTemp.Split();<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">计算背景图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (backgroundMask </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                backgroundMask </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, </span><span style="color: #0000ff;">byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(currentFrame.Size);<br>            backgroundMask.SetZero();<br>            </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">int</span><span style="color: #000000;"> i </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">; i </span><span style="color: #000000;">&lt;</span><span style="color: #000000;"> currentFrame.NumberOfChannels; i</span><span style="color: #000000;">++</span><span style="color: #000000;">)<br>                backgroundMask._Or(images[i].InRange(imagesLow[i], imagesHi[i]));<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">释放资源</span><span style="color: #008000;"><br></span><span style="color: #000000;">            </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">int</span><span style="color: #000000;"> i </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">; i </span><span style="color: #000000;">&lt;</span><span style="color: #000000;"> images.Length; i</span><span style="color: #000000;">++</span><span style="color: #000000;">)<br>                images[i].Dispose();<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取背景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> BackgroundMask<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> backgroundMask;<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取前景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> ForegroundMask<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> backgroundMask.Not();<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 释放资源<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> Dispose()<br>        {<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (imageAccSum </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                imageAccSum.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (imageAccSquare </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                imageAccSquare.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (previousFrame </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                previousFrame.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (currentFrame </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                currentFrame.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (backgroundMask </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                backgroundMask.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isStatDataReady)<br>            {<br>                </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">int</span><span style="color: #000000;"> i </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">; i </span><span style="color: #000000;">&lt;</span><span style="color: #000000;"> imagesHi.Length; i</span><span style="color: #000000;">++</span><span style="color: #000000;">)<br>                {<br>                    imagesHi[i].Dispose();<br>                    imagesLow[i].Dispose();<br>                }<br>            }<br>        }<br>    }<br><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> 使用标准协方差来建立背景模型<br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #008000;"><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;typeparam name="TColor"&gt;&lt;/typeparam&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">class</span><span style="color: #000000;"> BackgroundStatModelMultiplyAcc</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> : IBackgroundStatModel</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"><br>        </span><span style="color: #0000ff;">where</span><span style="color: #000000;"> TColor : </span><span style="color: #0000ff;">struct</span><span style="color: #000000;">, IColor<br>    {<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">成员</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageAccSum;          </span><span style="color: #008000;">//</span><span style="color: #008000;">累计图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageAccMultiply;     </span><span style="color: #008000;">//</span><span style="color: #008000;">累计平方图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> frameCount;                             </span><span style="color: #008000;">//</span><span style="color: #008000;">已经累计的背景帧数</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> previousFrame;        </span><span style="color: #008000;">//</span><span style="color: #008000;">在背景建模时使用的前一帧图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> currentFrame;           </span><span style="color: #008000;">//</span><span style="color: #008000;">当前帧图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">double</span><span style="color: #000000;"> scale;                               </span><span style="color: #008000;">//</span><span style="color: #008000;">计算背景时所使用的缩放系数，大于平均值*scale倍数的像素认为是前景</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> backgroundMask;           </span><span style="color: #008000;">//</span><span style="color: #008000;">计算得到的背景图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageTemp;            </span><span style="color: #008000;">//</span><span style="color: #008000;">临时图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isStatDataReady;                       </span><span style="color: #008000;">//</span><span style="color: #008000;">是否已经准备好统计数据</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">[] imagesHi;             </span><span style="color: #008000;">//</span><span style="color: #008000;">背景模型中各通道的最大值图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">[] imagesLow;            </span><span style="color: #008000;">//</span><span style="color: #008000;">背景模型中各通道的最小值图像</span><span style="color: #008000;"><br></span><span style="color: #000000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 构造函数<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> BackgroundStatModelMultiplyAcc()<br>        {<br>            imageAccSum </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            imageAccMultiply </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            frameCount </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">;<br>            previousFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            currentFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            scale </span><span style="color: #000000;">=</span><span style="color: #000000;"> 6d;<br>            backgroundMask </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            isStatDataReady </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>            imagesHi </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>            imagesLow </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 设置或者获取计算前景时所用的阀值<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">double</span><span style="color: #000000;"> Scale<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> scale;<br>            }<br>            </span><span style="color: #0000ff;">set</span><span style="color: #000000;"><br>            {<br>                scale </span><span style="color: #000000;">=</span><span style="color: #000000;"> value </span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;"> </span><span style="color: #000000;">?</span><span style="color: #000000;"> value : 6d;<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 更新背景模型<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;param name="image"&gt;&lt;/param&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> Update(Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> image)<br>        {<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (frameCount </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">)<br>            {<br>                imageAccSum </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(image.Size);<br>                imageAccSum.SetZero();<br>                imageAccMultiply </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, </span><span style="color: #0000ff;">float</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(image.Size);<br>                imageAccMultiply.SetZero();<br>            }<br>            imageTemp </span><span style="color: #000000;">=</span><span style="color: #000000;"> image.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(1d, 0d); </span><span style="color: #008000;">//</span><span style="color: #008000;">将图像转换成浮点型</span><span style="color: #008000;"><br></span><span style="color: #000000;">            imageAccSum.Acc(imageTemp);<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (previousFrame </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                CvInvoke.cvMultiplyAcc(previousFrame.Ptr, imageTemp.Ptr, imageAccMultiply.Ptr, IntPtr.Zero);<br>            previousFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageTemp.Copy();<br>            frameCount</span><span style="color: #000000;">++</span><span style="color: #000000;">;<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取或者设置当前帧<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> CurrentFrame<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> currentFrame;<br>            }<br>            </span><span style="color: #0000ff;">set</span><span style="color: #000000;"><br>            {<br>                currentFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> value;<br>                CalcBackgroundMask();<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 计算统计数据<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> CalcStatData()<br>        {<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">计算出标准协方差、最高及最低阀值图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageAvg </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageAccSum.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(1d </span><span style="color: #000000;">/</span><span style="color: #000000;"> frameCount, 0d);<br>            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageScov </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageAccMultiply.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(1d </span><span style="color: #000000;">/</span><span style="color: #000000;"> frameCount, 0d);<br>            imageScov.Sub(imageAvg.Pow(2d));<br>            imageScov </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageScov.Pow(</span><span style="color: #800080;">0.5d</span><span style="color: #000000;">);<br>            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageHi </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageAvg.Add(imageScov.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(scale, 0d));<br>            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageLow </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageAvg.Sub(imageScov.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(scale, 0d));<br>            imagesHi </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageHi.Split();<br>            imagesLow </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageLow.Split();<br>            isStatDataReady </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">释放资源</span><span style="color: #008000;"><br></span><span style="color: #000000;">            imageAvg.Dispose();<br>            imageScov.Dispose();<br>            imageHi.Dispose();<br>            imageLow.Dispose();<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 计算背景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> CalcBackgroundMask()<br>        {<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (imageAccSum </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;"> </span><span style="color: #000000;">||</span><span style="color: #000000;"> imageAccMultiply </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;"> </span><span style="color: #000000;">||</span><span style="color: #000000;"> imageAccSum.Size </span><span style="color: #000000;">!=</span><span style="color: #000000;"> currentFrame.Size)<br>                </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> ArgumentException(</span><span style="color: #800000;">"</span><span style="color: #800000;">在计算背景时发生参数错误。可能是：还没有建立背景模型；或者当前帧的尺寸与背景尺寸不一致。</span><span style="color: #800000;">"</span><span style="color: #000000;">);<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (</span><span style="color: #000000;">!</span><span style="color: #000000;">isStatDataReady)<br>                CalcStatData();<br>            imageTemp </span><span style="color: #000000;">=</span><span style="color: #000000;"> currentFrame.ConvertScale</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(1d, 0d);<br>            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Single</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">[] images </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageTemp.Split();<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">计算背景图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (backgroundMask </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                backgroundMask </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, </span><span style="color: #0000ff;">byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(currentFrame.Size);<br>            backgroundMask.SetZero();<br>            </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">int</span><span style="color: #000000;"> i </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">; i </span><span style="color: #000000;">&lt;</span><span style="color: #000000;"> currentFrame.NumberOfChannels; i</span><span style="color: #000000;">++</span><span style="color: #000000;">)<br>                backgroundMask._Or(images[i].InRange(imagesLow[i], imagesHi[i]));<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">释放资源</span><span style="color: #008000;"><br></span><span style="color: #000000;">            </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">int</span><span style="color: #000000;"> i </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">; i </span><span style="color: #000000;">&lt;</span><span style="color: #000000;"> images.Length; i</span><span style="color: #000000;">++</span><span style="color: #000000;">)<br>                images[i].Dispose();<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取背景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> BackgroundMask<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> backgroundMask;<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取前景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> ForegroundMask<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> backgroundMask.Not();<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 释放资源<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> Dispose()<br>        {<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (imageAccSum </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                imageAccSum.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (imageAccMultiply </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                imageAccMultiply.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (previousFrame </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                previousFrame.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (currentFrame </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                currentFrame.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (backgroundMask </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                backgroundMask.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isStatDataReady)<br>            {<br>                </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #0000ff;">int</span><span style="color: #000000;"> i </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">; i </span><span style="color: #000000;">&lt;</span><span style="color: #000000;"> imagesHi.Length; i</span><span style="color: #000000;">++</span><span style="color: #000000;">)<br>                {<br>                    imagesHi[i].Dispose();<br>                    imagesLow[i].Dispose();<br>                }<br>            }<br>        }<br>    }<br><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> 背景统计模型<br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">class</span><span style="color: #000000;"> BackgroundStatModelBase</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> : IBackgroundStatModel</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"><br>        </span><span style="color: #0000ff;">where</span><span style="color: #000000;"> TColor : </span><span style="color: #0000ff;">struct</span><span style="color: #000000;">, IColor<br>    {<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">成员变量</span><span style="color: #008000;"><br></span><span style="color: #000000;">        IBackgroundStatModel</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> bgModel;<br>        BackgroundStatModelType type;<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 构造函数<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;param name="type"&gt;</span><span style="color: #008000;">背景模型类型</span><span style="color: #808080;">&lt;/param&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> BackgroundStatModelBase(BackgroundStatModelType type)<br>        {<br>            </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.type </span><span style="color: #000000;">=</span><span style="color: #000000;"> type;<br>            </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (type)<br>            {<br>                </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> BackgroundStatModelType.FrameDiff:<br>                    bgModel </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> BackgroundStatModelFrameDiff</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">();<br>                    </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br>                </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> BackgroundStatModelType.AccAvg:<br>                    bgModel </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> BackgroundStatModelAccAvg</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">();<br>                    </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br>                </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> BackgroundStatModelType.RunningAvg:<br>                    bgModel </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> BackgroundStatModelRunningAvg</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">();<br>                    </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br>                </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> BackgroundStatModelType.SquareAcc:<br>                    bgModel </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> BackgroundStatModelSquareAcc</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">();<br>                    </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br>                </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> BackgroundStatModelType.MultiplyAcc:<br>                    bgModel </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> BackgroundStatModelMultiplyAcc</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">();<br>                    </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br>                </span><span style="color: #0000ff;">default</span><span style="color: #000000;">:<br>                    </span><span style="color: #0000ff;">throw</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> ArgumentException(</span><span style="color: #800000;">"</span><span style="color: #800000;">不存在的背景模型</span><span style="color: #800000;">"</span><span style="color: #000000;">, </span><span style="color: #800000;">"</span><span style="color: #800000;">type</span><span style="color: #800000;">"</span><span style="color: #000000;">);<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取背景模型类型<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> BackgroundStatModelType BackgroundStatModelType<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> type;<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 更新背景模型<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;param name="image"&gt;&lt;/param&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> Update(Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> image)<br>        {<br>            bgModel.Update(image);<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 计算统计数据<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> CalcStatData()<br>        {<br>            bgModel.CalcStatData();<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 设置或者获取当前帧<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">TColor, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> CurrentFrame<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> bgModel.CurrentFrame;<br>            }<br>            </span><span style="color: #0000ff;">set</span><span style="color: #000000;"><br>            {<br>                bgModel.CurrentFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> value;<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取背景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> BackgroundMask<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> bgModel.BackgroundMask;<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 获取前景<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> ForegroundMask<br>        {<br>            </span><span style="color: #0000ff;">get</span><span style="color: #000000;"><br>            {<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> bgModel.ForegroundMask;<br>            }<br>        }<br><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> 释放资源<br>        </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> Dispose()<br>        {<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgModel </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                bgModel.Dispose();<br>        }<br>    }<br><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> 背景模型类型<br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> BackgroundStatModelType<br>    {<br>        FrameDiff,      </span><span style="color: #008000;">//</span><span style="color: #008000;">帧差</span><span style="color: #008000;"><br></span><span style="color: #000000;">        AccAvg,         </span><span style="color: #008000;">//</span><span style="color: #008000;">平均背景</span><span style="color: #008000;"><br></span><span style="color: #000000;">        RunningAvg,     </span><span style="color: #008000;">//</span><span style="color: #008000;">均值漂移</span><span style="color: #008000;"><br></span><span style="color: #000000;">        MultiplyAcc,    </span><span style="color: #008000;">//</span><span style="color: #008000;">计算协方差</span><span style="color: #008000;"><br></span><span style="color: #000000;">        SquareAcc       </span><span style="color: #008000;">//</span><span style="color: #008000;">计算方差</span><span style="color: #008000;"><br></span><span style="color: #000000;">    }<br>}</span></div></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
</div>
<p>&nbsp;</p>
<p><b>3.编码本背景模型</b><br>&nbsp;&nbsp;&nbsp; 编码本的基本思路是这样的：针对每个像素在时间轴上的变动，建立多个（或者一个）包容近期所有变化的Box（变动范围）；在检测时，用当前像素与Box去比较，如果当前像素落在任何Box的范围内，则为背景。<br>&nbsp;&nbsp;&nbsp; 在OpenCv中已经实现了编码本背景模型，不过实现方式与《学习OpenCv》中提到的方式略有不同，主要有：（1）使用单向链表来容纳Code Element；（2）清除消极的Code Element时，并未重置t。OpenCv中的以下函数与编码本背景模型相关：<br>cvCreateBGCodeBookModel&nbsp; 建立背景模型<br>cvBGCodeBookUpdate&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 更新背景模型<br>cvBGCodeBookClearStale&nbsp;&nbsp; 清除消极的Code Element<br>cvBGCodeBookDiff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 计算得到背景与前景（注意：该函数仅仅设置背景像素为0，而对前景像素未处理，因此在调用前需要将所有的像素先置为前景）<br>cvReleaseBGCodeBookModel 释放资源<br>&nbsp;&nbsp;&nbsp; 在EmguCv中只实现了一部分编码本背景模型，在类BGCodeBookModel&lt;TColor&gt;中，可惜它把cvBGCodeBookDiff给搞忘记了 -_-<br>下面的代码演示了如果使用编码本背景模型：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show(&#39;6f6fe063-43bd-4756-a35c-6129b09ea6e9&#39;)"><img id="code_img_closed_6f6fe063-43bd-4756-a35c-6129b09ea6e9" class="code_img_closed" src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/ContractedBlock.gif" style="display: none;"><img style="" id="code_img_opened_6f6fe063-43bd-4756-a35c-6129b09ea6e9" class="code_img_opened" onclick="cnblogs_code_hide(&#39;6f6fe063-43bd-4756-a35c-6129b09ea6e9&#39;,event)" src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/ExpandedBlockStart.gif"><span class="cnblogs_code_collapse" style="display: none;">编码本模型</span>
<div id="cnblogs_code_open_6f6fe063-43bd-4756-a35c-6129b09ea6e9" class="cnblogs_code_hide" style="display: block;"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #000000;">            </span><span style="color: #008000;">//</span><span style="color: #008000;">（1）初始化对象</span><span style="color: #008000;"><br></span><span style="color: #000000;">            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbCodeBook.Checked)<br>            {<br>                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgCodeBookModel </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                {<br>                    bgCodeBookModel.Dispose();<br>                    bgCodeBookModel </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>                }<br>                bgCodeBookModel </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> BGCodeBookModel</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">();<br>            }<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">（2）背景建模或者前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">            </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> stop </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>            </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (</span><span style="color: #000000;">!</span><span style="color: #000000;">stop)<br>            {<br>                Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> image </span><span style="color: #000000;">=</span><span style="color: #000000;"> capture.QueryFrame().Clone();  </span><span style="color: #008000;">//</span><span style="color: #008000;">当前帧</span><span style="color: #008000;"><br></span><span style="color: #000000;">                </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isBgModeling, isFgDetecting;                       </span><span style="color: #008000;">//</span><span style="color: #008000;">是否正在建模，是否正在前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">                </span><span style="color: #0000ff;">lock</span><span style="color: #000000;"> (lockObject)<br>                {<br>                    stop </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #000000;">!</span><span style="color: #000000;">isVideoCapturing;<br>                    isBgModeling </span><span style="color: #000000;">=</span><span style="color: #000000;"> isBackgroundModeling;<br>                    isFgDetecting </span><span style="color: #000000;">=</span><span style="color: #000000;"> isForegroundDetecting;<br>                }<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">得到设置的参数</span><span style="color: #008000;"><br></span><span style="color: #000000;">                SettingParam param </span><span style="color: #000000;">=</span><span style="color: #000000;"> (SettingParam)</span><span style="color: #0000ff;">this</span><span style="color: #000000;">.Invoke(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> GetSettingParamDelegate(GetSettingParam));<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">code book</span><span style="color: #008000;"><br></span><span style="color: #000000;">                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (param.ForegroundDetectType </span><span style="color: #000000;">==</span><span style="color: #000000;"> ForegroundDetectType.CodeBook)<br>                {<br>                    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgCodeBookModel </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                    {<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isBgModeling)<br>                        {<br>                            bgCodeBookModel.Update(image);<br>                            </span><span style="color: #008000;">//</span><span style="color: #008000;">背景建模一段时间之后，清理陈旧的条目 (因为清理操作不会重置t，所以这里用求余数的办法来决定清理的时机)</span><span style="color: #008000;"><br></span><span style="color: #000000;">                            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (backgroundModelFrameCount </span><span style="color: #000000;">%</span><span style="color: #000000;"> CodeBookClearPeriod </span><span style="color: #000000;">==</span><span style="color: #000000;"> CodeBookClearPeriod </span><span style="color: #000000;">-</span><span style="color: #000000;"> </span><span style="color: #800080;">1</span><span style="color: #000000;">)<br>                                bgCodeBookModel.ClearStale(CodeBookStaleThresh, Rectangle.Empty, </span><span style="color: #0000ff;">null</span><span style="color: #000000;">);<br>                            backgroundModelFrameCount</span><span style="color: #000000;">++</span><span style="color: #000000;">;<br>                            pbBackgroundModel.Image </span><span style="color: #000000;">=</span><span style="color: #000000;"> bgCodeBookModel.BackgroundMask.Bitmap;<br>                            </span><span style="color: #008000;">//</span><span style="color: #008000;">如果达到最大背景建模次数，停止背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">                            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (param.MaxBackgroundModelFrameCount </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;"> </span><span style="color: #000000;">&amp;&amp;</span><span style="color: #000000;"> backgroundModelFrameCount </span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> param.MaxBackgroundModelFrameCount)<br>                                </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.Invoke(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> NoParamAndReturnDelegate(StopBackgroundModel));<br>                        }<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isFgDetecting)<br>                        {<br>                            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageFg </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, </span><span style="color: #0000ff;">byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(image.Size);<br>                            imageFg.SetValue(255d);     </span><span style="color: #008000;">//</span><span style="color: #008000;">CodeBook在得出前景时，仅仅将背景像素置零，所以这里需要先将所有的像素都假设为前景</span><span style="color: #008000;"><br></span><span style="color: #000000;">                            CvInvoke.cvBGCodeBookDiff(bgCodeBookModel.Ptr, image.Ptr, imageFg.Ptr, Rectangle.Empty);<br>                            pbBackgroundModel.Image </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageFg.Bitmap;<br>                        }<br>                    }<br>                }<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">更新视频图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">                pbVideo.Image </span><span style="color: #000000;">=</span><span style="color: #000000;"> image.Bitmap;<br>            }<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">（3）释放对象</span><span style="color: #008000;"><br></span><span style="color: #000000;">            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgCodeBookModel </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>            {<br>                </span><span style="color: #0000ff;">try</span><span style="color: #000000;"><br>                {<br>                    bgCodeBookModel.Dispose();<br>                }<br>                </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> { }<br>            }</span></div></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
</div>
<p>&nbsp;</p>
<p><b>4.高级背景统计模型<br></b>&nbsp;&nbsp;&nbsp; 在OpenCv还实现了两种高级的背景统计模型，它们为别是：（1）FGD——复杂背景下的前景物体检测(Foreground object detection from videos containing complex background)；（2）MOG——高斯混合模型(Mixture Of Gauss)。包括以下函数：<br>CvCreateFGDetectorBase&nbsp; 建立前景检测对象<br>CvFGDetectorProcess&nbsp;&nbsp;&nbsp;&nbsp; 更新前景检测对象<br>CvFGDetectorGetMask&nbsp;&nbsp;&nbsp;&nbsp; 获取前景<br>CvFGDetectorRelease&nbsp;&nbsp;&nbsp;&nbsp; 释放资源<br>&nbsp;&nbsp;&nbsp; EmguCv将其封装到类FGDetector&lt;TColor&gt;中。我个人觉得OpenCv在实现这个模型的时候做得不太好，因为它将背景建模和前景检测糅合到一起了，无论你是否愿意，在建模的过程中也会检测前景，而只希望前景检测的时候，同时也会建模。我比较喜欢将背景建模和前景检测进行分离的设计。<br>调用的过程很简单，代码如下：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show(&#39;a315f9fc-7354-4b89-9efe-29a5f341ab0a&#39;)"><img id="code_img_closed_a315f9fc-7354-4b89-9efe-29a5f341ab0a" class="code_img_closed" src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/ContractedBlock.gif" style="display: none;"><img style="" id="code_img_opened_a315f9fc-7354-4b89-9efe-29a5f341ab0a" class="code_img_opened" onclick="cnblogs_code_hide(&#39;a315f9fc-7354-4b89-9efe-29a5f341ab0a&#39;,event)" src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/ExpandedBlockStart.gif"><span class="cnblogs_code_collapse" style="display: none;">高级背景统计模型</span>
<div id="cnblogs_code_open_a315f9fc-7354-4b89-9efe-29a5f341ab0a" class="cnblogs_code_hide" style="display: block;"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #000000;">            </span><span style="color: #008000;">//</span><span style="color: #008000;">(1)创建对象</span><span style="color: #008000;"><br></span><span style="color: #000000;">            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbMog.Checked)<br>            {<br>                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (fgDetector </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                {<br>                    fgDetector.Dispose();<br>                    fgDetector </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>                }<br>                fgDetector </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> FGDetector</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(FORGROUND_DETECTOR_TYPE.FGD);<br>            }<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbFgd.Checked)<br>            {<br>                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (fgDetector </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                {<br>                    fgDetector.Dispose();<br>                    fgDetector </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>                }<br>                fgDetector </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> FGDetector</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(FORGROUND_DETECTOR_TYPE.MOG);<br>            }<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">背景建模及前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">            </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> stop </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>            </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (</span><span style="color: #000000;">!</span><span style="color: #000000;">stop)<br>            {<br>                Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> image </span><span style="color: #000000;">=</span><span style="color: #000000;"> capture.QueryFrame().Clone();  </span><span style="color: #008000;">//</span><span style="color: #008000;">当前帧</span><span style="color: #008000;"><br></span><span style="color: #000000;">                </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isBgModeling, isFgDetecting;                       </span><span style="color: #008000;">//</span><span style="color: #008000;">是否正在建模，是否正在前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">                </span><span style="color: #0000ff;">lock</span><span style="color: #000000;"> (lockObject)<br>                {<br>                    stop </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #000000;">!</span><span style="color: #000000;">isVideoCapturing;<br>                    isBgModeling </span><span style="color: #000000;">=</span><span style="color: #000000;"> isBackgroundModeling;<br>                    isFgDetecting </span><span style="color: #000000;">=</span><span style="color: #000000;"> isForegroundDetecting;<br>                }<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">得到设置的参数</span><span style="color: #008000;"><br></span><span style="color: #000000;">                SettingParam param </span><span style="color: #000000;">=</span><span style="color: #000000;"> (SettingParam)</span><span style="color: #0000ff;">this</span><span style="color: #000000;">.Invoke(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> GetSettingParamDelegate(GetSettingParam));<br>                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (param.ForegroundDetectType </span><span style="color: #000000;">==</span><span style="color: #000000;"> ForegroundDetectType.Fgd </span><span style="color: #000000;">||</span><span style="color: #000000;"> param.ForegroundDetectType </span><span style="color: #000000;">==</span><span style="color: #000000;"> ForegroundDetectType.Mog)<br>                {<br>                    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (fgDetector </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;"> </span><span style="color: #000000;">&amp;&amp;</span><span style="color: #000000;"> (isBgModeling </span><span style="color: #000000;">||</span><span style="color: #000000;"> isFgDetecting))<br>                    {<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        fgDetector.Update(image);<br>                        backgroundModelFrameCount</span><span style="color: #000000;">++</span><span style="color: #000000;">;<br>                        pbBackgroundModel.Image </span><span style="color: #000000;">=</span><span style="color: #000000;"> fgDetector.BackgroundMask.Bitmap;<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">如果达到最大背景建模次数，停止背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (param.MaxBackgroundModelFrameCount </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;"> </span><span style="color: #000000;">&amp;&amp;</span><span style="color: #000000;"> backgroundModelFrameCount </span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> param.MaxBackgroundModelFrameCount)<br>                            </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.Invoke(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> NoParamAndReturnDelegate(StopBackgroundModel));<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isFgDetecting)<br>                        {<br>                            pbBackgroundModel.Image </span><span style="color: #000000;">=</span><span style="color: #000000;"> fgDetector.ForgroundMask.Bitmap;<br>                        }<br>                    }<br>                }<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">更新视频图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">                pbVideo.Image </span><span style="color: #000000;">=</span><span style="color: #000000;"> image.Bitmap;<br>            }<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">（3）释放资源</span><span style="color: #008000;"><br></span><span style="color: #000000;">            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (fgDetector </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>            {<br>                </span><span style="color: #0000ff;">try</span><span style="color: #000000;"><br>                {<br>                    fgDetector.Dispose();<br>                }<br>                </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> { }<br>            }</span></div></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
</div>
<p>&nbsp;</p>
<p><b>前景检测</b><br>&nbsp;&nbsp;&nbsp; 在建立好背景模型之后，通过对当前图像及背景的某种比较，我们可以得出前景。在上面的介绍中，已经包含了对前景的代码，在此不再重复。一般情况下，得到的前景包含了很多噪声，为了消除噪声，我们可以对前景图像进行开运算及闭运算，然后再丢弃比较小的轮廓。</p>
<p><b>本文的代码</b></p>
<div class="cnblogs_code" onclick="cnblogs_code_show(&#39;563e46b4-ca16-451c-a4f9-65c3cf3d7fc0&#39;)"><img id="code_img_closed_563e46b4-ca16-451c-a4f9-65c3cf3d7fc0" class="code_img_closed" src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/ContractedBlock.gif" style="display: none;"><img style="" id="code_img_opened_563e46b4-ca16-451c-a4f9-65c3cf3d7fc0" class="code_img_opened" onclick="cnblogs_code_hide(&#39;563e46b4-ca16-451c-a4f9-65c3cf3d7fc0&#39;,event)" src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/ExpandedBlockStart.gif"><span class="cnblogs_code_collapse" style="display: none;">本文代码</span>
<div id="cnblogs_code_open_563e46b4-ca16-451c-a4f9-65c3cf3d7fc0" class="cnblogs_code_hide" style="display: block;"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #0000ff;">using</span><span style="color: #000000;"> System;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Collections.Generic;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.ComponentModel;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Data;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Drawing;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Linq;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Text;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Windows.Forms;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Diagnostics;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Runtime.InteropServices;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Threading;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> Emgu.CV;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> Emgu.CV.CvEnum;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> Emgu.CV.Structure;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> Emgu.CV.UI;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> Emgu.CV.VideoSurveillance;<br><br></span><span style="color: #0000ff;">namespace</span><span style="color: #000000;"> ImageProcessLearn<br>{<br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">partial</span><span style="color: #000000;"> </span><span style="color: #0000ff;">class</span><span style="color: #000000;"> FormForegroundDetect : Form<br>    {<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">成员变量</span><span style="color: #008000;"><br></span><span style="color: #000000;">        Capture capture </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;                         </span><span style="color: #008000;">//</span><span style="color: #008000;">视频捕获对象</span><span style="color: #008000;"><br></span><span style="color: #000000;">        Thread captureThread </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;                    </span><span style="color: #008000;">//</span><span style="color: #008000;">视频捕获线程</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isVideoCapturing </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;           </span><span style="color: #008000;">//</span><span style="color: #008000;">是否正在捕获视频</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isBackgroundModeling </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;      </span><span style="color: #008000;">//</span><span style="color: #008000;">是否正在背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> backgroundModelFrameCount </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">;      </span><span style="color: #008000;">//</span><span style="color: #008000;">已经建模的视频帧数</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isForegroundDetecting </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;     </span><span style="color: #008000;">//</span><span style="color: #008000;">是否正在进行前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">object</span><span style="color: #000000;"> lockObject </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> </span><span style="color: #0000ff;">object</span><span style="color: #000000;">();       </span><span style="color: #008000;">//</span><span style="color: #008000;">用于锁定的对象<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">各种前景检测方法对应的对象</span><span style="color: #008000;"><br></span><span style="color: #000000;">        BGCodeBookModel</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> bgCodeBookModel </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;    </span><span style="color: #008000;">//</span><span style="color: #008000;">编码本前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> CodeBookClearPeriod </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">40</span><span style="color: #000000;">;     </span><span style="color: #008000;">//</span><span style="color: #008000;">编码本的清理周期，更新这么多次背景之后，清理掉很少使用的陈旧条目</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">const</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> CodeBookStaleThresh </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">20</span><span style="color: #000000;">;     </span><span style="color: #008000;">//</span><span style="color: #008000;">在清理编码本时，使用的阀值（stale大于该阀值的条目将被删除）</span><span style="color: #008000;"><br></span><span style="color: #000000;">        FGDetector</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> fgDetector </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;              </span><span style="color: #008000;">//</span><span style="color: #008000;">Mog或者Fgd检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">        BackgroundStatModelFrameDiff</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> bgModelFrameDiff </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;      </span><span style="color: #008000;">//</span><span style="color: #008000;">帧差</span><span style="color: #008000;"><br></span><span style="color: #000000;">        BackgroundStatModelAccAvg</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> bgModelAccAvg </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;            </span><span style="color: #008000;">//</span><span style="color: #008000;">平均背景</span><span style="color: #008000;"><br></span><span style="color: #000000;">        BackgroundStatModelRunningAvg</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> bgModelRunningAvg </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;    </span><span style="color: #008000;">//</span><span style="color: #008000;">均值漂移</span><span style="color: #008000;"><br></span><span style="color: #000000;">        BackgroundStatModelSquareAcc</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> bgModelSquareAcc </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;      </span><span style="color: #008000;">//</span><span style="color: #008000;">标准方差</span><span style="color: #008000;"><br></span><span style="color: #000000;">        BackgroundStatModelMultiplyAcc</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> bgModelMultiplyAcc </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;  </span><span style="color: #008000;">//</span><span style="color: #008000;">标准协方差</span><span style="color: #008000;"><br></span><span style="color: #000000;"><br><br>        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> FormForegroundDetect()<br>        {<br>            InitializeComponent();<br>        }<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">窗体加载时</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> FormForegroundDetect_Load(</span><span style="color: #0000ff;">object</span><span style="color: #000000;"> sender, EventArgs e)<br>        {<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">设置Tooltip</span><span style="color: #008000;"><br></span><span style="color: #000000;">            toolTip.Active </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>            toolTip.SetToolTip(rbMog, </span><span style="color: #800000;">"</span><span style="color: #800000;">高斯混合模型(Mixture Of Gauss)</span><span style="color: #800000;">"</span><span style="color: #000000;">);<br>            toolTip.SetToolTip(rbFgd, </span><span style="color: #800000;">"</span><span style="color: #800000;">复杂背景下的前景物体检测(Foreground object detection from videos containing complex background)</span><span style="color: #800000;">"</span><span style="color: #000000;">);<br>            toolTip.SetToolTip(txtMaxBackgroundModelFrameCount, </span><span style="color: #800000;">"</span><span style="color: #800000;">在背景建模时，使用的最大帧数，超出该值之后，将自动停止背景建模。\r\n对于帧差，总是只捕捉当前帧作为背景。\r\n如果设为零，背景检测将不会自动停止。</span><span style="color: #800000;">"</span><span style="color: #000000;">);<br>            <br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">打开摄像头视频捕获线程</span><span style="color: #008000;"><br></span><span style="color: #000000;">            capture </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Capture(</span><span style="color: #800080;">0</span><span style="color: #000000;">);<br>            captureThread </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Thread(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> ParameterizedThreadStart(CaptureWithEmguCv));<br>            captureThread.Start(</span><span style="color: #0000ff;">null</span><span style="color: #000000;">);<br>        }<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">窗体关闭前</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> FormForegroundDetect_FormClosing(</span><span style="color: #0000ff;">object</span><span style="color: #000000;"> sender, FormClosingEventArgs e)<br>        {<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">终止视频捕获</span><span style="color: #008000;"><br></span><span style="color: #000000;">            isVideoCapturing </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (captureThread </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                captureThread.Abort();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (capture </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                capture.Dispose();<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">释放对象</span><span style="color: #008000;"><br></span><span style="color: #000000;">            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgCodeBookModel </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>            {<br>                </span><span style="color: #0000ff;">try</span><span style="color: #000000;"><br>                {<br>                    bgCodeBookModel.Dispose();<br>                }<br>                </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> { }<br>            }<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (fgDetector </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>            {<br>                </span><span style="color: #0000ff;">try</span><span style="color: #000000;"><br>                {<br>                    fgDetector.Dispose();<br>                }<br>                </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> { }<br>            }<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgModelFrameDiff </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                bgModelFrameDiff.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgModelAccAvg </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                bgModelAccAvg.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgModelRunningAvg </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                bgModelRunningAvg.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgModelSquareAcc </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                bgModelSquareAcc.Dispose();<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgModelMultiplyAcc </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                bgModelMultiplyAcc.Dispose();<br>        }<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">EmguCv视频捕获</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> CaptureWithEmguCv(</span><span style="color: #0000ff;">object</span><span style="color: #000000;"> objParam)<br>        {<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (capture </span><span style="color: #000000;">==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;<br>            </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> stop </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>            </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> (</span><span style="color: #000000;">!</span><span style="color: #000000;">stop)<br>            {<br>                Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> image </span><span style="color: #000000;">=</span><span style="color: #000000;"> capture.QueryFrame().Clone();  </span><span style="color: #008000;">//</span><span style="color: #008000;">当前帧</span><span style="color: #008000;"><br></span><span style="color: #000000;">                </span><span style="color: #0000ff;">bool</span><span style="color: #000000;"> isBgModeling, isFgDetecting;                       </span><span style="color: #008000;">//</span><span style="color: #008000;">是否正在建模，是否正在前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">                </span><span style="color: #0000ff;">lock</span><span style="color: #000000;"> (lockObject)<br>                {<br>                    stop </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #000000;">!</span><span style="color: #000000;">isVideoCapturing;<br>                    isBgModeling </span><span style="color: #000000;">=</span><span style="color: #000000;"> isBackgroundModeling;<br>                    isFgDetecting </span><span style="color: #000000;">=</span><span style="color: #000000;"> isForegroundDetecting;<br>                }<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">得到设置的参数</span><span style="color: #008000;"><br></span><span style="color: #000000;">                SettingParam param </span><span style="color: #000000;">=</span><span style="color: #000000;"> (SettingParam)</span><span style="color: #0000ff;">this</span><span style="color: #000000;">.Invoke(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> GetSettingParamDelegate(GetSettingParam));<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">code book</span><span style="color: #008000;"><br></span><span style="color: #000000;">                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (param.ForegroundDetectType </span><span style="color: #000000;">==</span><span style="color: #000000;"> ForegroundDetectType.CodeBook)<br>                {<br>                    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgCodeBookModel </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;"> </span><span style="color: #000000;">&amp;&amp;</span><span style="color: #000000;"> (isBgModeling </span><span style="color: #000000;">||</span><span style="color: #000000;"> isFgDetecting))<br>                    {<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isBgModeling)<br>                        {<br>                            bgCodeBookModel.Update(image);<br>                            </span><span style="color: #008000;">//</span><span style="color: #008000;">背景建模一段时间之后，清理陈旧的条目</span><span style="color: #008000;"><br></span><span style="color: #000000;">                            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (backgroundModelFrameCount </span><span style="color: #000000;">%</span><span style="color: #000000;"> CodeBookClearPeriod </span><span style="color: #000000;">==</span><span style="color: #000000;"> CodeBookClearPeriod </span><span style="color: #000000;">-</span><span style="color: #000000;"> </span><span style="color: #800080;">1</span><span style="color: #000000;">)<br>                                bgCodeBookModel.ClearStale(CodeBookStaleThresh, Rectangle.Empty, </span><span style="color: #0000ff;">null</span><span style="color: #000000;">);<br>                            backgroundModelFrameCount</span><span style="color: #000000;">++</span><span style="color: #000000;">;<br>                            pbBackgroundModel.Image </span><span style="color: #000000;">=</span><span style="color: #000000;"> bgCodeBookModel.BackgroundMask.Bitmap;<br>                            </span><span style="color: #008000;">//</span><span style="color: #008000;">如果达到最大背景建模次数，停止背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">                            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (param.MaxBackgroundModelFrameCount </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;"> </span><span style="color: #000000;">&amp;&amp;</span><span style="color: #000000;"> backgroundModelFrameCount </span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> param.MaxBackgroundModelFrameCount)<br>                                </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.Invoke(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> NoParamAndReturnDelegate(StopBackgroundModel));<br>                        }<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isFgDetecting)<br>                        {<br>                            Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, Byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> imageFg </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Image</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Gray, </span><span style="color: #0000ff;">byte</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(image.Size);<br>                            imageFg.SetValue(255d);     </span><span style="color: #008000;">//</span><span style="color: #008000;">CodeBook在得出前景时，仅仅将背景像素置零，所以这里需要先将所有的像素都假设为前景</span><span style="color: #008000;"><br></span><span style="color: #000000;">                            CvInvoke.cvBGCodeBookDiff(bgCodeBookModel.Ptr, image.Ptr, imageFg.Ptr, Rectangle.Empty);<br>                            pbBackgroundModel.Image </span><span style="color: #000000;">=</span><span style="color: #000000;"> imageFg.Bitmap;<br>                        }<br>                    }<br>                }<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">fgd or mog</span><span style="color: #008000;"><br></span><span style="color: #000000;">                </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (param.ForegroundDetectType </span><span style="color: #000000;">==</span><span style="color: #000000;"> ForegroundDetectType.Fgd </span><span style="color: #000000;">||</span><span style="color: #000000;"> param.ForegroundDetectType </span><span style="color: #000000;">==</span><span style="color: #000000;"> ForegroundDetectType.Mog)<br>                {<br>                    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (fgDetector </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;"> </span><span style="color: #000000;">&amp;&amp;</span><span style="color: #000000;"> (isBgModeling </span><span style="color: #000000;">||</span><span style="color: #000000;"> isFgDetecting))<br>                    {<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        fgDetector.Update(image);<br>                        backgroundModelFrameCount</span><span style="color: #000000;">++</span><span style="color: #000000;">;<br>                        pbBackgroundModel.Image </span><span style="color: #000000;">=</span><span style="color: #000000;"> fgDetector.BackgroundMask.Bitmap;<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">如果达到最大背景建模次数，停止背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (param.MaxBackgroundModelFrameCount </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;"> </span><span style="color: #000000;">&amp;&amp;</span><span style="color: #000000;"> backgroundModelFrameCount </span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> param.MaxBackgroundModelFrameCount)<br>                            </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.Invoke(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> NoParamAndReturnDelegate(StopBackgroundModel));<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isFgDetecting)<br>                        {<br>                            pbBackgroundModel.Image </span><span style="color: #000000;">=</span><span style="color: #000000;"> fgDetector.ForgroundMask.Bitmap;<br>                        }<br>                    }<br>                }<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">帧差</span><span style="color: #008000;"><br></span><span style="color: #000000;">                </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (param.ForegroundDetectType </span><span style="color: #000000;">==</span><span style="color: #000000;"> ForegroundDetectType.FrameDiff)<br>                {<br>                    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgModelFrameDiff </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                    {<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isBgModeling)<br>                        {<br>                            bgModelFrameDiff.Update(image);<br>                            backgroundModelFrameCount</span><span style="color: #000000;">++</span><span style="color: #000000;">;<br>                            </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.Invoke(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> NoParamAndReturnDelegate(StopBackgroundModel)); </span><span style="color: #008000;">//</span><span style="color: #008000;">对于帧差，只需要捕获当前帧作为背景即可</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        }<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isFgDetecting)<br>                        {<br>                            bgModelFrameDiff.Threshold </span><span style="color: #000000;">=</span><span style="color: #000000;"> param.Threshold;<br>                            bgModelFrameDiff.CurrentFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> image;<br>                            pbBackgroundModel.Image </span><span style="color: #000000;">=</span><span style="color: #000000;"> bgModelFrameDiff.ForegroundMask.Bitmap;<br>                        }<br>                    }<br>                }<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">平均背景</span><span style="color: #008000;"><br></span><span style="color: #000000;">                </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (param.ForegroundDetectType </span><span style="color: #000000;">==</span><span style="color: #000000;"> ForegroundDetectType.AccAvg)<br>                {<br>                    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgModelAccAvg</span><span style="color: #000000;">!=</span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                    {<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isBgModeling)<br>                        {<br>                            bgModelAccAvg.Update(image);<br>                            backgroundModelFrameCount</span><span style="color: #000000;">++</span><span style="color: #000000;">;<br>                            </span><span style="color: #008000;">//</span><span style="color: #008000;">如果达到最大背景建模次数，停止背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">                            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (param.MaxBackgroundModelFrameCount </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;"> </span><span style="color: #000000;">&amp;&amp;</span><span style="color: #000000;"> backgroundModelFrameCount </span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> param.MaxBackgroundModelFrameCount)<br>                                </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.Invoke(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> NoParamAndReturnDelegate(StopBackgroundModel));<br>                        }<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isFgDetecting)<br>                        {<br>                            bgModelAccAvg.CurrentFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> image;<br>                            pbBackgroundModel.Image </span><span style="color: #000000;">=</span><span style="color: #000000;"> bgModelAccAvg.ForegroundMask.Bitmap;<br>                        }<br>                    }<br>                }<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">均值漂移</span><span style="color: #008000;"><br></span><span style="color: #000000;">                </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (param.ForegroundDetectType </span><span style="color: #000000;">==</span><span style="color: #000000;"> ForegroundDetectType.RunningAvg)<br>                {<br>                    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgModelRunningAvg </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                    {<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isBgModeling)<br>                        {<br>                            bgModelRunningAvg.Update(image);<br>                            backgroundModelFrameCount</span><span style="color: #000000;">++</span><span style="color: #000000;">;<br>                            </span><span style="color: #008000;">//</span><span style="color: #008000;">如果达到最大背景建模次数，停止背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">                            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (param.MaxBackgroundModelFrameCount </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;"> </span><span style="color: #000000;">&amp;&amp;</span><span style="color: #000000;"> backgroundModelFrameCount </span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> param.MaxBackgroundModelFrameCount)<br>                                </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.Invoke(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> NoParamAndReturnDelegate(StopBackgroundModel));<br>                        }<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isFgDetecting)<br>                        {<br>                            bgModelRunningAvg.CurrentFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> image;<br>                            pbBackgroundModel.Image </span><span style="color: #000000;">=</span><span style="color: #000000;"> bgModelRunningAvg.ForegroundMask.Bitmap;<br>                        }<br>                    }<br>                }<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">计算方差</span><span style="color: #008000;"><br></span><span style="color: #000000;">                </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (param.ForegroundDetectType </span><span style="color: #000000;">==</span><span style="color: #000000;"> ForegroundDetectType.SquareAcc)<br>                {<br>                    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgModelSquareAcc </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                    {<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isBgModeling)<br>                        {<br>                            bgModelSquareAcc.Update(image);<br>                            backgroundModelFrameCount</span><span style="color: #000000;">++</span><span style="color: #000000;">;<br>                            </span><span style="color: #008000;">//</span><span style="color: #008000;">如果达到最大背景建模次数，停止背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">                            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (param.MaxBackgroundModelFrameCount </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;"> </span><span style="color: #000000;">&amp;&amp;</span><span style="color: #000000;"> backgroundModelFrameCount </span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> param.MaxBackgroundModelFrameCount)<br>                                </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.Invoke(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> NoParamAndReturnDelegate(StopBackgroundModel));<br>                        }<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isFgDetecting)<br>                        {<br>                            bgModelSquareAcc.CurrentFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> image;<br>                            pbBackgroundModel.Image </span><span style="color: #000000;">=</span><span style="color: #000000;"> bgModelSquareAcc.ForegroundMask.Bitmap;<br>                        }<br>                    }<br>                }<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">协方差</span><span style="color: #008000;"><br></span><span style="color: #000000;">                </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (param.ForegroundDetectType </span><span style="color: #000000;">==</span><span style="color: #000000;"> ForegroundDetectType.MultiplyAcc)<br>                {<br>                    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgModelMultiplyAcc </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                    {<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isBgModeling)<br>                        {<br>                            bgModelMultiplyAcc.Update(image);<br>                            backgroundModelFrameCount</span><span style="color: #000000;">++</span><span style="color: #000000;">;<br>                            </span><span style="color: #008000;">//</span><span style="color: #008000;">如果达到最大背景建模次数，停止背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">                            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (param.MaxBackgroundModelFrameCount </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;"> </span><span style="color: #000000;">&amp;&amp;</span><span style="color: #000000;"> backgroundModelFrameCount </span><span style="color: #000000;">&gt;</span><span style="color: #000000;"> param.MaxBackgroundModelFrameCount)<br>                                </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.Invoke(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> NoParamAndReturnDelegate(StopBackgroundModel));<br>                        }<br>                        </span><span style="color: #008000;">//</span><span style="color: #008000;">前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (isFgDetecting)<br>                        {<br>                            bgModelMultiplyAcc.CurrentFrame </span><span style="color: #000000;">=</span><span style="color: #000000;"> image;<br>                            pbBackgroundModel.Image </span><span style="color: #000000;">=</span><span style="color: #000000;"> bgModelMultiplyAcc.ForegroundMask.Bitmap;<br>                        }<br>                    }<br>                }<br>                </span><span style="color: #008000;">//</span><span style="color: #008000;">更新视频图像</span><span style="color: #008000;"><br></span><span style="color: #000000;">                pbVideo.Image </span><span style="color: #000000;">=</span><span style="color: #000000;"> image.Bitmap;<br>            }<br>        }<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">用于在工作线程中更新结果的委托及方法</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">delegate</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> AddResultDelegate(</span><span style="color: #0000ff;">string</span><span style="color: #000000;"> result);<br>        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> AddResultMethod(</span><span style="color: #0000ff;">string</span><span style="color: #000000;"> result)<br>        {<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">txtResult.Text += result;</span><span style="color: #008000;"><br></span><span style="color: #000000;">        }<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">用于在工作线程中获取设置参数的委托及方法</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">delegate</span><span style="color: #000000;"> SettingParam GetSettingParamDelegate();<br>        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> SettingParam GetSettingParam()<br>        {<br>            ForegroundDetectType type </span><span style="color: #000000;">=</span><span style="color: #000000;"> ForegroundDetectType.FrameDiff;<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbFrameDiff.Checked)<br>                type </span><span style="color: #000000;">=</span><span style="color: #000000;"> ForegroundDetectType.FrameDiff;<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbAccAvg.Checked)<br>                type </span><span style="color: #000000;">=</span><span style="color: #000000;"> ForegroundDetectType.AccAvg;<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbRunningAvg.Checked)<br>                type </span><span style="color: #000000;">=</span><span style="color: #000000;"> ForegroundDetectType.RunningAvg;<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbMultiplyAcc.Checked)<br>                type </span><span style="color: #000000;">=</span><span style="color: #000000;"> ForegroundDetectType.MultiplyAcc;<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbSquareAcc.Checked)<br>                type </span><span style="color: #000000;">=</span><span style="color: #000000;"> ForegroundDetectType.SquareAcc;<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbCodeBook.Checked)<br>                type </span><span style="color: #000000;">=</span><span style="color: #000000;"> ForegroundDetectType.CodeBook;<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbMog.Checked)<br>                type </span><span style="color: #000000;">=</span><span style="color: #000000;"> ForegroundDetectType.Mog;<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"><br>                type </span><span style="color: #000000;">=</span><span style="color: #000000;"> ForegroundDetectType.Fgd;<br>            </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> maxFrameCount </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">;<br>            </span><span style="color: #0000ff;">int</span><span style="color: #000000;">.TryParse(txtMaxBackgroundModelFrameCount.Text, </span><span style="color: #0000ff;">out</span><span style="color: #000000;"> maxFrameCount);<br>            </span><span style="color: #0000ff;">double</span><span style="color: #000000;"> threshold </span><span style="color: #000000;">=</span><span style="color: #000000;"> 15d;<br>            </span><span style="color: #0000ff;">double</span><span style="color: #000000;">.TryParse(txtThreshold.Text, </span><span style="color: #0000ff;">out</span><span style="color: #000000;"> threshold);<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (threshold </span><span style="color: #000000;">&lt;=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">)<br>                threshold </span><span style="color: #000000;">=</span><span style="color: #000000;"> 15d;<br>            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> SettingParam(type, maxFrameCount, threshold);<br>        }<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">没有参数及返回值的委托</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">delegate</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> NoParamAndReturnDelegate();<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">开始背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> btnStartBackgroundModel_Click(</span><span style="color: #0000ff;">object</span><span style="color: #000000;"> sender, EventArgs e)<br>        {<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbCodeBook.Checked)<br>            {<br>                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgCodeBookModel </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                {<br>                    bgCodeBookModel.Dispose();<br>                    bgCodeBookModel </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>                }<br>                bgCodeBookModel </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> BGCodeBookModel</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">();<br>            }<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbMog.Checked)<br>            {<br>                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (fgDetector </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                {<br>                    fgDetector.Dispose();<br>                    fgDetector </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>                }<br>                fgDetector </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> FGDetector</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(FORGROUND_DETECTOR_TYPE.FGD);<br>            }<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbFgd.Checked)<br>            {<br>                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (fgDetector </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                {<br>                    fgDetector.Dispose();<br>                    fgDetector </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>                }<br>                fgDetector </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> FGDetector</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(FORGROUND_DETECTOR_TYPE.MOG);<br>            }<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbFrameDiff.Checked)<br>            {<br>                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgModelFrameDiff </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                {<br>                    bgModelFrameDiff.Dispose();<br>                    bgModelFrameDiff </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>                }<br>                bgModelFrameDiff </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> BackgroundStatModelFrameDiff</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">();<br>            }<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbAccAvg.Checked)<br>            {<br>                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgModelAccAvg </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                {<br>                    bgModelAccAvg.Dispose();<br>                    bgModelAccAvg </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>                }<br>                bgModelAccAvg </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> BackgroundStatModelAccAvg</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">();<br>            }<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbRunningAvg.Checked)<br>            {<br>                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgModelRunningAvg </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                {<br>                    bgModelRunningAvg.Dispose();<br>                    bgModelRunningAvg </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>                }<br>                bgModelRunningAvg </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> BackgroundStatModelRunningAvg</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">();<br>            }<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbSquareAcc.Checked)<br>            {<br>                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgModelSquareAcc </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                {<br>                    bgModelSquareAcc.Dispose();<br>                    bgModelSquareAcc </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>                }<br>                bgModelSquareAcc </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> BackgroundStatModelSquareAcc</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">();<br>            }<br>            </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (rbMultiplyAcc.Checked)<br>            {<br>                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (bgModelMultiplyAcc </span><span style="color: #000000;">!=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                {<br>                    bgModelMultiplyAcc.Dispose();<br>                    bgModelMultiplyAcc </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>                }<br>                bgModelMultiplyAcc </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> BackgroundStatModelMultiplyAcc</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">Bgr</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">();<br>            }<br>            backgroundModelFrameCount </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">0</span><span style="color: #000000;">;<br>            isBackgroundModeling </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>            btnStartBackgroundModel.Enabled </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>            btnStopBackgroundModel.Enabled </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>            btnStartForegroundDetect.Enabled </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>            btnStopForegroundDetect.Enabled </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>        }<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">停止背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> btnStopBackgroundModel_Click(</span><span style="color: #0000ff;">object</span><span style="color: #000000;"> sender, EventArgs e)<br>        {<br>            StopBackgroundModel();<br>        }<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">停止背景建模</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> StopBackgroundModel()<br>        {<br>            </span><span style="color: #0000ff;">lock</span><span style="color: #000000;"> (lockObject)<br>            {<br>                isBackgroundModeling </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>            }<br>            btnStartBackgroundModel.Enabled </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>            btnStopBackgroundModel.Enabled </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>            btnStartForegroundDetect.Enabled </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>            btnStopForegroundDetect.Enabled </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>        }<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">开始前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> btnStartForegroundDetect_Click(</span><span style="color: #0000ff;">object</span><span style="color: #000000;"> sender, EventArgs e)<br>        {<br>            isForegroundDetecting </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>            btnStartBackgroundModel.Enabled </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>            btnStopBackgroundModel.Enabled </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>            btnStartForegroundDetect.Enabled </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>            btnStopForegroundDetect.Enabled </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>        }<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">停止前景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">        </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> btnStopForegroundDetect_Click(</span><span style="color: #0000ff;">object</span><span style="color: #000000;"> sender, EventArgs e)<br>        {<br>            </span><span style="color: #0000ff;">lock</span><span style="color: #000000;"> (lockObject)<br>            {<br>                isForegroundDetecting </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>            }<br>            btnStartBackgroundModel.Enabled </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>            btnStopBackgroundModel.Enabled </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>            btnStartForegroundDetect.Enabled </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>            btnStopForegroundDetect.Enabled </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>        }<br>    }<br><br>    </span><span style="color: #008000;">//</span><span style="color: #008000;">前景检测方法枚举</span><span style="color: #008000;"><br></span><span style="color: #000000;">    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">enum</span><span style="color: #000000;"> ForegroundDetectType<br>    {<br>        FrameDiff,<br>        AccAvg,<br>        RunningAvg,<br>        MultiplyAcc,<br>        SquareAcc,<br>        CodeBook,<br>        Mog,<br>        Fgd<br>    }<br><br>    </span><span style="color: #008000;">//</span><span style="color: #008000;">设置参数</span><span style="color: #008000;"><br></span><span style="color: #000000;">    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">struct</span><span style="color: #000000;"> SettingParam<br>    {<br>        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> ForegroundDetectType ForegroundDetectType;<br>        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> MaxBackgroundModelFrameCount;<br>        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">double</span><span style="color: #000000;"> Threshold;<br><br>        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> SettingParam(ForegroundDetectType foregroundDetectType, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> maxBackgroundModelFrameCount, </span><span style="color: #0000ff;">double</span><span style="color: #000000;"> threshold)<br>        {<br>            ForegroundDetectType </span><span style="color: #000000;">=</span><span style="color: #000000;"> foregroundDetectType;<br>            MaxBackgroundModelFrameCount </span><span style="color: #000000;">=</span><span style="color: #000000;"> maxBackgroundModelFrameCount;<br>            Threshold </span><span style="color: #000000;">=</span><span style="color: #000000;"> threshold;<br>        }<br>    }<br>}</span></div></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
</div>
<p>&nbsp;&nbsp;&nbsp; 另外，细心的读者发现我忘记贴OpenCvInvoke类的实现代码了，这里补上。多谢指正。</p>
<p>
</p><div class="cnblogs_code" onclick="cnblogs_code_show(&#39;8a54f389-935a-4953-a65d-0de1bedf10f0&#39;)"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/ContractedBlock.gif" class="code_img_closed" id="code_img_closed_8a54f389-935a-4953-a65d-0de1bedf10f0" style="display: none;"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/ExpandedBlockStart.gif" class="code_img_opened" id="code_img_opened_8a54f389-935a-4953-a65d-0de1bedf10f0" onclick="cnblogs_code_hide(&#39;8a54f389-935a-4953-a65d-0de1bedf10f0&#39;,event)" style=""><span class="cnblogs_code_collapse" style="display: none;">OpenCvInvoke实现代码</span>
<div id="cnblogs_code_open_8a54f389-935a-4953-a65d-0de1bedf10f0" class="cnblogs_code_hide" style="display: block;"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #0000ff;">using</span><span style="color: #000000;"> System;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Collections.Generic;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Linq;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Text;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Drawing;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> System.Runtime.InteropServices;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> Emgu.CV.Structure;<br></span><span style="color: #0000ff;">using</span><span style="color: #000000;"> Emgu.CV.CvEnum;<br><br></span><span style="color: #0000ff;">namespace</span><span style="color: #000000;"> ImageProcessLearn<br>{<br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;summary&gt;</span><span style="color: #008000;"><br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> 声明一些没有包含在EmguCv中的OpenCv函数<br>    </span><span style="color: #808080;">///</span><span style="color: #008000;"> </span><span style="color: #808080;">&lt;/summary&gt;</span><span style="color: #808080;"><br></span><span style="color: #000000;">    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">class</span><span style="color: #000000;"> OpenCvInvoke<br>    {<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">自适应动态背景检测</span><span style="color: #008000;"><br></span><span style="color: #000000;">        [DllImport(</span><span style="color: #800000;">"</span><span style="color: #800000;">cvaux200.dll</span><span style="color: #800000;">"</span><span style="color: #000000;">)]<br>        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">extern</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> cvChangeDetection(IntPtr prev_frame, IntPtr curr_frame, IntPtr change_mask);<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">均值漂移分割</span><span style="color: #008000;"><br></span><span style="color: #000000;">        [DllImport(</span><span style="color: #800000;">"</span><span style="color: #800000;">cv200.dll</span><span style="color: #800000;">"</span><span style="color: #000000;">)]<br>        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">extern</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> cvPyrMeanShiftFiltering(IntPtr src, IntPtr dst, </span><span style="color: #0000ff;">double</span><span style="color: #000000;"> spatialRadius, </span><span style="color: #0000ff;">double</span><span style="color: #000000;"> colorRadius, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> max_level, MCvTermCriteria termcrit);<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">开始查找轮廓</span><span style="color: #008000;"><br></span><span style="color: #000000;">        [DllImport(</span><span style="color: #800000;">"</span><span style="color: #800000;">cv200.dll</span><span style="color: #800000;">"</span><span style="color: #000000;">)]<br>        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">extern</span><span style="color: #000000;"> IntPtr cvStartFindContours(IntPtr image, IntPtr storage, </span><span style="color: #0000ff;">int</span><span style="color: #000000;"> header_size, RETR_TYPE mode, CHAIN_APPROX_METHOD method, Point offset);<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">查找下一个轮廓</span><span style="color: #008000;"><br></span><span style="color: #000000;">        [DllImport(</span><span style="color: #800000;">"</span><span style="color: #800000;">cv200.dll</span><span style="color: #800000;">"</span><span style="color: #000000;">)]<br>        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">extern</span><span style="color: #000000;"> IntPtr cvFindNextContour(IntPtr scanner);<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">用新轮廓替换scanner指向的当前轮廓</span><span style="color: #008000;"><br></span><span style="color: #000000;">        [DllImport(</span><span style="color: #800000;">"</span><span style="color: #800000;">cv200.dll</span><span style="color: #800000;">"</span><span style="color: #000000;">)]<br>        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">extern</span><span style="color: #000000;"> </span><span style="color: #0000ff;">void</span><span style="color: #000000;"> cvSubstituteContour(IntPtr scanner, IntPtr new_contour);<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">结束轮廓查找</span><span style="color: #008000;"><br></span><span style="color: #000000;">        [DllImport(</span><span style="color: #800000;">"</span><span style="color: #800000;">cv200.dll</span><span style="color: #800000;">"</span><span style="color: #000000;">)]<br>        </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> </span><span style="color: #0000ff;">static</span><span style="color: #000000;"> </span><span style="color: #0000ff;">extern</span><span style="color: #000000;"> IntPtr cvEndFindContour(</span><span style="color: #0000ff;">ref</span><span style="color: #000000;"> IntPtr scanner);<br>    }<br>}</span></div></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/copycode.gif" alt="复制代码"></a></span></div></div>
</div>
<p>&nbsp;</p>
<p></p>
<p>&nbsp;</p>
<p><b>后记<br></b>&nbsp;&nbsp; &nbsp;值得注意的是，本文提到的OpenCv函数目前属于CvAux系列，以后也许会加入到正式的图像处理Cv系列，也许以后会消失。最重要的是它们还没有正式的文档。</p>
<p>&nbsp;&nbsp;&nbsp; 其实关于背景模型的方法还有很多，比如《Video-object segmentation using multi-sprite background subtraction》可以在摄像机运动的情况下建立背景，《Nonparametric background generation》利用mean-shift算法处理动态的背景模型，如果我的时间和能力允许，也许会去尝试实现它们。另外，《Wallflower: Principles and practice of background maintenance》比较了各种背景建模方式的差异，我希望能够尝试翻译出来。</p>
<p>&nbsp;&nbsp;&nbsp; <b>感谢您耐心看完本文，希望对您有所帮助。</b></p></div><div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="BlogPostCategory">分类: <a href="http://www.cnblogs.com/xrwang/category/231541.html" target="_blank">图像处理</a></div>
<div id="EntryTag"></div>
<div id="blog_post_info"><div id="green_channel">
        <a href="javascript:void(0);" id="green_channel_digg" onclick="DiggIt(1670768,cb_blogId,1);green_channel_success(this,&#39;谢谢推荐！&#39;);">好文要顶</a>
            <a id="green_channel_follow" onclick="follow(&#39;716e3d0b-63cf-dd11-9e4d-001cf0cd104b&#39;);" href="javascript:void(0);">关注我</a>
    <a id="green_channel_favorite" onclick="AddToWz(cb_entryId);return false;" href="javascript:void(0);">收藏该文</a>
    <a id="green_channel_weibo" href="javascript:void(0);" title="分享至新浪微博" onclick="ShareToTsina()"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/icon_weibo_24.png" alt=""></a>
    <a id="green_channel_wechat" href="javascript:void(0);" title="分享至微信" onclick="shareOnWechat()"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/wechat.png" alt=""></a>
</div>
<div id="author_profile">
    <div id="author_profile_info" class="author_profile_info">
            <a href="http://home.cnblogs.com/u/xrwang/" target="_blank"><img src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/u21602.jpg" class="author_avatar" alt=""></a>
        <div id="author_profile_detail" class="author_profile_info">
            <a href="http://home.cnblogs.com/u/xrwang/">Wuya</a><br>
            <a href="http://home.cnblogs.com/u/xrwang/followees">关注 - 5</a><br>
            <a href="http://home.cnblogs.com/u/xrwang/followers">粉丝 - 452</a>
        </div>
    </div>
    <div class="clear"></div>
    <div id="author_profile_honor"></div>
    <div id="author_profile_follow">
                <a href="javascript:void(0);" onclick="follow(&#39;716e3d0b-63cf-dd11-9e4d-001cf0cd104b&#39;);return false;">+加关注</a>
    </div>
</div>
<div id="div_digg">
    <div class="diggit" onclick="votePost(1670768,&#39;Digg&#39;)">
        <span class="diggnum" id="digg_count">19</span>
    </div>
    <div class="buryit" onclick="votePost(1670768,&#39;Bury&#39;)">
        <span class="burynum" id="bury_count">0</span>
    </div>
    <div class="clear"></div>
    <div class="diggword" id="digg_tips">
    </div>
</div>
</div>
<div class="clear"></div>
<div id="post_next_prev"><a href="http://www.cnblogs.com/xrwang/archive/2010/02/13/HowToCaptureCameraVideoViaDotNet.html" class="p_n_p_prefix">« </a> 上一篇：<a href="http://www.cnblogs.com/xrwang/archive/2010/02/13/HowToCaptureCameraVideoViaDotNet.html" title="发布于2010-02-13 15:20">.net中捕获摄像头视频的方式及对比(How to Capture Camera Video via .Net)</a><br><a href="http://www.cnblogs.com/xrwang/archive/2010/02/28/ImageSegmentation.html" class="p_n_p_prefix">» </a> 下一篇：<a href="http://www.cnblogs.com/xrwang/archive/2010/02/28/ImageSegmentation.html" title="发布于2010-02-28 09:33">图像分割(Image Segmentation)</a><br></div>
</div>


		</div>
		<div class="postDesc">posted @ <span id="post-date">2010-02-21 23:11</span> <a href="http://www.cnblogs.com/xrwang/">Wuya</a> 阅读(<span id="post_view_count">33952</span>) 评论(<span id="post_comment_count">61</span>)  <a href="https://i.cnblogs.com/EditPosts.aspx?postid=1670768" rel="nofollow">编辑</a> <a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#" onclick="AddToWz(1670768);return false;">收藏</a></div>
	</div>
	<script type="text/javascript">var allowComments=true,cb_blogId=25161,cb_entryId=1670768,cb_blogApp=currentBlogApp,cb_blogUserGuid='716e3d0b-63cf-dd11-9e4d-001cf0cd104b',cb_entryCreatedDate='2010/2/21 23:11:00';loadViewCount(cb_entryId);</script>
	
</div><!--end: topics 文章、评论容器-->
</div><a name="!comments"></a><div id="blog-comments-placeholder"><div id="comments_pager_top"><div class="pager"><a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#!comments" onclick="commentManager.renderComments(1,50);return false;">&lt; Prev</a><a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#!comments" onclick="commentManager.renderComments(1,50);return false;">1</a><span class="current">2</span></div></div>
<!--done-->
<div class="feedback_area_title">评论列表</div>
<div class="feedbackNoItems"></div>
	

		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#3054958" class="layer">#51楼</a><a name="3054958" id="comment_anchor_3054958"></a>  <span class="comment_date">2014-10-31 13:40</span> <a id="a_comment_author_3054958" href="http://home.cnblogs.com/u/687717/" target="_blank">SPDreamer</a> <a href="http://msg.cnblogs.com/send/SPDreamer" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_3054958" class="blog_comment_body">太厉害了楼主，我刚学习这块</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3054958,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3054958,&#39;Bury&#39;,this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#3137862" class="layer">#52楼</a><a name="3137862" id="comment_anchor_3137862"></a>  <span class="comment_date">2015-03-09 20:12</span> <a id="a_comment_author_3137862" href="http://home.cnblogs.com/u/289336/" target="_blank">歆萌</a> <a href="http://msg.cnblogs.com/send/%E6%AD%86%E8%90%8C" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_3137862" class="blog_comment_body">楼主所说的源代码下载里有链接是在哪里啊？我觉得可以在此文中贴出来的~话说我把评论看完了，也没找到在哪里下代码~看到回复，谢谢楼主，近期研究这块，很多不懂~</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3137862,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3137862,&#39;Bury&#39;,this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#3137979" class="layer">#53楼</a><a name="3137979" id="comment_anchor_3137979"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2015-03-10 09:08</span> <a id="a_comment_author_3137979" href="http://www.cnblogs.com/xrwang/" target="_blank">Wuya</a> <a href="http://msg.cnblogs.com/send/Wuya" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_3137979" class="blog_comment_body"><a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#3137862" title="查看所回复的评论" onclick="commentManager.renderComments(0,50,3137862);">@</a>
歆萌<br>专门有篇文章叫《源代码下载》。<br>代码太长，全部贴出来没意思。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3137979,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3137979,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_3137979_avatar" style="display:none;">http://pic.cnblogs.com/face/u21602.jpg</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#3170601" class="layer">#54楼</a><a name="3170601" id="comment_anchor_3170601"></a>  <span class="comment_date">2015-04-26 16:00</span> <a id="a_comment_author_3170601" href="http://home.cnblogs.com/u/739031/" target="_blank">ceryuan</a> <a href="http://msg.cnblogs.com/send/ceryuan" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_3170601" class="blog_comment_body">博主您好，我借鉴了您的代码，实现了检测，而现在正在研究怎么将检测到的大区域给圈出来，看到了一个合适的参数：MCvBlob。<br><br>可是用这个代码来圈的时候，即使看到的已经是背景，但是仍然会在当前帧中圈出一些blob，这样实在不太好。是否可以请您指点一下？<br><br>其实我想实现的效果，就是检测到和背景不一样的物品出现时，能够自动截图，并且有一个阀值可以过滤掉出现的杂物。<br><br>我调用的是BlobTrackerAuto&lt;Bgr&gt; tracker = null;//定义跟踪器;<br>而用foreach (MCvBlob blob in tracker)时，一开始检测的结果是正常的，而到后面变回背景时，还有大量的小团块绘制在界面上，不会随着fgDetector的检测结果消失而消失。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3170601,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3170601,&#39;Bury&#39;,this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#3171471" class="layer">#55楼</a><a name="3171471" id="comment_anchor_3171471"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2015-04-27 19:22</span> <a id="a_comment_author_3171471" href="http://www.cnblogs.com/xrwang/" target="_blank">Wuya</a> <a href="http://msg.cnblogs.com/send/Wuya" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_3171471" class="blog_comment_body"><a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#3170601" title="查看所回复的评论" onclick="commentManager.renderComments(0,50,3170601);">@</a>
ceryuan<br>您可以检测轮廓，标记出较大的轮廓即可。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3171471,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3171471,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_3171471_avatar" style="display:none;">http://pic.cnblogs.com/face/u21602.jpg</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#3175988" class="layer">#56楼</a><a name="3175988" id="comment_anchor_3175988"></a>  <span class="comment_date">2015-05-05 08:07</span> <a id="a_comment_author_3175988" href="http://www.cnblogs.com/ruoyear/" target="_blank">ceryuan</a> <a href="http://msg.cnblogs.com/send/ceryuan" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_3175988" class="blog_comment_body"><a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#3171471" title="查看所回复的评论" onclick="commentManager.renderComments(0,50,3171471);">@</a>
Wuya<br>谢谢，这个已经通过研究找到方法，就是循环到后期时会非常卡，很耗时间。<br>所以现在正在研究您写的foreground的代码，看看怎么直接在检测前景达到阀值时自动保存截图。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3175988,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3175988,&#39;Bury&#39;,this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#3181437" class="layer">#57楼</a><a name="3181437" id="comment_anchor_3181437"></a>  <span class="comment_date">2015-05-12 08:53</span> <a id="a_comment_author_3181437" href="http://home.cnblogs.com/u/755735/" target="_blank">注册木头人</a> <a href="http://msg.cnblogs.com/send/%E6%B3%A8%E5%86%8C%E6%9C%A8%E5%A4%B4%E4%BA%BA" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_3181437" class="blog_comment_body">LZ,自己配置好Emgucv文件还是有很多问题,能给出源代码下载的链接么？至于楼主说的《源代码下载》一文中下载更是在网上找的云里雾里...邮箱274271421@qq.com,拜谢...</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3181437,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3181437,&#39;Bury&#39;,this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#3182173" class="layer">#58楼</a><a name="3182173" id="comment_anchor_3182173"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2015-05-12 20:30</span> <a id="a_comment_author_3182173" href="http://www.cnblogs.com/xrwang/" target="_blank">Wuya</a> <a href="http://msg.cnblogs.com/send/Wuya" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_3182173" class="blog_comment_body"><a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#3181437" title="查看所回复的评论" onclick="commentManager.renderComments(0,50,3181437);">@</a>
注册木头人<br><a href="http://www.cnblogs.com/xrwang/archive/2010/12/20/SourceCode.html" target="_blank">http://www.cnblogs.com/xrwang/archive/2010/12/20/SourceCode.html</a></div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3182173,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3182173,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_3182173_avatar" style="display:none;">http://pic.cnblogs.com/face/u21602.jpg</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#3324888" class="layer">#59楼</a><a name="3324888" id="comment_anchor_3324888"></a>  <span class="comment_date">2015-12-11 09:24</span> <a id="a_comment_author_3324888" href="http://home.cnblogs.com/u/855358/" target="_blank">华仔最帅</a> <a href="http://msg.cnblogs.com/send/%E5%8D%8E%E4%BB%94%E6%9C%80%E5%B8%85" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_3324888" class="blog_comment_body">感谢您的分享，受益匪浅</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3324888,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3324888,&#39;Bury&#39;,this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#3331573" class="layer">#60楼</a><a name="3331573" id="comment_anchor_3331573"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2015-12-21 22:17</span> <a id="a_comment_author_3331573" href="http://www.cnblogs.com/xrwang/" target="_blank">Wuya</a> <a href="http://msg.cnblogs.com/send/Wuya" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_3331573" class="blog_comment_body"><a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#3324888" title="查看所回复的评论" onclick="commentManager.renderComments(0,50,3324888);">@</a>
华仔最帅<br>^_^</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3331573,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3331573,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_3331573_avatar" style="display:none;">http://pic.cnblogs.com/face/u21602.jpg</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#3624767" class="layer">#61楼</a><a name="3624767" id="comment_anchor_3624767"></a><span id="comment-maxId" style="display:none;">3624767</span><span id="comment-maxDate" style="display:none;">2017/2/23 11:06:59</span>  <span class="comment_date">2017-02-23 11:06</span> <a id="a_comment_author_3624767" href="http://home.cnblogs.com/u/1111843/" target="_blank">小福贵啦啦</a> <a href="http://msg.cnblogs.com/send/%E5%B0%8F%E7%A6%8F%E8%B4%B5%E5%95%A6%E5%95%A6" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_3624767" class="blog_comment_body">感谢楼主无私分享，非常谢谢，比爱心</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(3624767,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(3624767,&#39;Bury&#39;,this)">反对(0)</a></div>
			</div>
		</div>
	<div id="comments_pager_bottom"><div class="pager"><a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#!comments" onclick="commentManager.renderComments(1,50);return false;">&lt; Prev</a><a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#!comments" onclick="commentManager.renderComments(1,50);return false;">1</a><span class="current">2</span></div></div></div><script type="text/javascript">var commentManager = new blogCommentManager();commentManager.renderComments(0);</script>
<div id="comment_form" class="commentform">
<a name="commentform"></a>
<div id="divCommentShow"></div>
<div id="comment_nav"><span id="span_refresh_tips"></span><a href="javascript:void(0);" onclick="return RefreshCommentList();" id="lnk_RefreshComments" runat="server" clientidmode="Static">刷新评论</a><a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#" onclick="return RefreshPage();">刷新页面</a><a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#top">返回顶部</a></div>
<div id="comment_form_container"><div class="login_tips">注册用户登录后才能发表评论，请 <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return login(&#39;commentform&#39;);">登录</a> 或 <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return register();">注册</a>，<a href="http://www.cnblogs.com/">访问</a>网站首页。</div></div>
<div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
<div id="ad_t2"><a href="http://www.ucancode.com/index.htm" target="_blank">【推荐】50万行VC++源码: 大型组态工控、电力仿真CAD与GIS源码库</a><br><a href="http://cn.udacity.com/fend/?utm_source=cnblogs&utm_medium=referral&utm_campaign=newFEND" target="_blank">【推荐】Google+GitHub联手打造前端工程师课程</a><br></div>
<div id="opt_under_post"></div>
<div id="ad_c1" class="c_ad_block">     <ins class="adsbygoogle" style="display: inline-block; width: 300px; height: 250px;" data-ad-client="ca-pub-4210569241504288" data-ad-slot="5457903683" data-adsbygoogle-status="done"><ins id="aswift_0_expand" style="display:inline-table;border:none;height:250px;margin:0;padding:0;position:relative;visibility:visible;width:300px;background-color:transparent"><ins id="aswift_0_anchor" style="display:block;border:none;height:250px;margin:0;padding:0;position:relative;visibility:visible;width:300px;background-color:transparent"><iframe width="300" height="250" frameborder="0" marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" scrolling="no" allowfullscreen="true" onload="var i=this.id,s=window.google_iframe_oncopy,H=s&amp;&amp;s.handlers,h=H&amp;&amp;H[i],w=this.contentWindow,d;try{d=w.document}catch(e){}if(h&amp;&amp;d&amp;&amp;(!d.body||!d.body.firstChild)){if(h.call){setTimeout(h,0)}else if(h.match){try{h=s.upd(h,i)}catch(e){}w.location.replace(h)}}" id="aswift_0" name="aswift_0" style="left:0;position:absolute;top:0;"></iframe></ins></ins></ins></div>
<div id="under_post_news"><div class="itnews c_ad_block"><b>最新IT新闻</b>:<br> ·  <a href="http://news.cnblogs.com/n/564512/" target="_blank">马化腾的焦虑并非作秀，网络效应的可靠程度可能被过度神化了</a><br> ·  <a href="http://news.cnblogs.com/n/564511/" target="_blank">星巴克把酿酒的技术用在了咖啡上，容我喝一杯82年的咖啡压压惊</a><br> ·  <a href="http://news.cnblogs.com/n/564510/" target="_blank">网易云音乐上线重磅功能 可一键上传短视频</a><br> ·  <a href="http://news.cnblogs.com/n/564509/" target="_blank">不用光学雷达，AImotive正在研发低成本自动驾驶系统</a><br> ·  <a href="http://news.cnblogs.com/n/564508/" target="_blank">微软发招，苹果发飙，React Native躺枪</a><br>» <a href="http://news.cnblogs.com/" title="IT新闻" target="_blank">更多新闻...</a></div></div>
<div id="ad_c2" class="c_ad_block"><a href="http://bbs.h3bpm.com/index.php?m=app&app=product_download&a=reg&utm_source=csdn&utm_medium=pic&utm_campaign=show&utm_content=v10&utm_term=%E5%85%8D%E8%B4%B9%E4%B8%8B%E8%BD%BD" target="_blank"><img width="468" height="60" src="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/24442-20170118152220281-363324784.jpg" alt=""></a></div>
<div id="under_post_kb"><div class="itnews c_ad_block" id="kb_block"><b>最新知识库文章</b>:<br><div id="kb_recent"> ·  <a href="http://kb.cnblogs.com/page/562433/" target="_blank">垃圾回收原来是这么回事</a><br> ·  <a href="http://kb.cnblogs.com/page/554260/" target="_blank">「代码家」的学习过程和学习经验分享</a><br> ·  <a href="http://kb.cnblogs.com/page/556770/" target="_blank">写给未来的程序媛</a><br> ·  <a href="http://kb.cnblogs.com/page/558087/" target="_blank">高质量的工程代码为什么难写</a><br> ·  <a href="http://kb.cnblogs.com/page/555750/" target="_blank">循序渐进地代码重构</a><br></div>» <a href="http://kb.cnblogs.com/" target="_blank">更多知识库文章...</a></div></div>
<div id="HistoryToday" class="c_ad_block"></div>
<script type="text/javascript">
    fixPostBody();
    setTimeout(function () { incrementViewCount(cb_entryId); }, 50);
    deliverAdT2();
    deliverAdC1();
    deliverAdC2();    
    loadNewsAndKb();
    loadBlogSignature();
    LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
    GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate);
    loadOptUnderPost();
    GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);   
</script>
</div>


	</div><!--end: forFlow -->
	</div><!--end: mainContent 主体内容容器-->

	<div id="sideBar">
		<div id="sideBarMain">
			
<!--done-->
<div class="newsItem">
<h3 class="catListTitle">公告</h3>
	<div id="blog-news"><div id="profile_block">昵称：<a href="http://home.cnblogs.com/u/xrwang/">Wuya</a><br>园龄：<a href="http://home.cnblogs.com/u/xrwang/" title="入园时间：2007-03-16">9年11个月</a><br>粉丝：<a href="http://home.cnblogs.com/u/xrwang/followers/">452</a><br>关注：<a href="http://home.cnblogs.com/u/xrwang/followees/">5</a><div id="p_b_follow"><a href="javascript:void(0);" onclick="follow(&#39;716e3d0b-63cf-dd11-9e4d-001cf0cd104b&#39;)">+加关注</a></div></div></div><script type="text/javascript">loadBlogNews();</script>
</div>

			<div id="calendar"><div id="blog-calendar" style=""><table id="blogCalendar" class="Cal" cellspacing="0" cellpadding="0" title="Calendar">
	<tbody><tr><td colspan="7"><table class="CalTitle" cellspacing="0">
		<tbody><tr><td class="CalNextPrev"><a href="javascript:void(0);" onclick="loadBlogCalendar(&#39;2010/01/01&#39;);return false;">&lt;</a></td><td align="center">2010年2月</td><td class="CalNextPrev" align="right"><a href="javascript:void(0);" onclick="loadBlogCalendar(&#39;2010/03/01&#39;);return false;">&gt;</a></td></tr>
	</tbody></table></td></tr><tr><th class="CalDayHeader" align="center" abbr="日" scope="col">日</th><th class="CalDayHeader" align="center" abbr="一" scope="col">一</th><th class="CalDayHeader" align="center" abbr="二" scope="col">二</th><th class="CalDayHeader" align="center" abbr="三" scope="col">三</th><th class="CalDayHeader" align="center" abbr="四" scope="col">四</th><th class="CalDayHeader" align="center" abbr="五" scope="col">五</th><th class="CalDayHeader" align="center" abbr="六" scope="col">六</th></tr><tr><td class="CalOtherMonthDay" align="center">31</td><td align="center">1</td><td align="center"><a href="http://www.cnblogs.com/xrwang/archive/2010/02/02.html"><u>2</u></a></td><td align="center">3</td><td align="center"><a href="http://www.cnblogs.com/xrwang/archive/2010/02/04.html"><u>4</u></a></td><td align="center"><a href="http://www.cnblogs.com/xrwang/archive/2010/02/05.html"><u>5</u></a></td><td class="CalWeekendDay" align="center">6</td></tr><tr><td class="CalWeekendDay" align="center">7</td><td align="center">8</td><td align="center"><a href="http://www.cnblogs.com/xrwang/archive/2010/02/09.html"><u>9</u></a></td><td align="center">10</td><td align="center">11</td><td align="center">12</td><td class="CalWeekendDay" align="center"><a href="http://www.cnblogs.com/xrwang/archive/2010/02/13.html"><u>13</u></a></td></tr><tr><td class="CalWeekendDay" align="center">14</td><td align="center">15</td><td align="center">16</td><td align="center">17</td><td align="center">18</td><td align="center">19</td><td class="CalWeekendDay" align="center">20</td></tr><tr><td class="CalWeekendDay" align="center"><a href="http://www.cnblogs.com/xrwang/archive/2010/02/21.html"><u>21</u></a></td><td align="center">22</td><td align="center">23</td><td align="center">24</td><td align="center">25</td><td align="center">26</td><td class="CalWeekendDay" align="center">27</td></tr><tr><td class="CalWeekendDay" align="center"><a href="http://www.cnblogs.com/xrwang/archive/2010/02/28.html"><u>28</u></a></td><td class="CalOtherMonthDay" align="center">1</td><td class="CalOtherMonthDay" align="center">2</td><td class="CalOtherMonthDay" align="center">3</td><td class="CalOtherMonthDay" align="center">4</td><td class="CalOtherMonthDay" align="center">5</td><td class="CalOtherMonthDay" align="center">6</td></tr><tr><td class="CalOtherMonthDay" align="center">7</td><td class="CalOtherMonthDay" align="center">8</td><td class="CalOtherMonthDay" align="center">9</td><td class="CalOtherMonthDay" align="center">10</td><td class="CalOtherMonthDay" align="center">11</td><td class="CalOtherMonthDay" align="center">12</td><td class="CalOtherMonthDay" align="center">13</td></tr>
</tbody></table></div><script type="text/javascript">loadBlogDefaultCalendar();</script></div>
			
			<div id="leftcontentcontainer">
				<div id="blog-sidecolumn"><div id="sidebar_search" class="sidebar-block">
<div id="sidebar_search" class="mySearch">
<h3 class="catListTitle">搜索</h3>
<div id="sidebar_search_box">
<div id="widget_my_zzk" class="div_my_zzk"><input type="text" id="q" onkeydown="return zzk_go_enter(event);" class="input_my_zzk">&nbsp;<input onclick="zzk_go()" type="button" value="找找看" id="btnZzk" class="btn_my_zzk"></div>

</div>
</div>

</div><div id="sidebar_shortcut" class="sidebar-block">
<div class="catListLink">
<h3 class="catListTitle">常用链接</h3>
<ul>
<li><a href="http://www.cnblogs.com/xrwang/p/" title="我的博客的随笔列表">我的随笔</a></li><li><a href="http://www.cnblogs.com/xrwang/MyComments.html" title="我发表过的评论列表">我的评论</a></li><li><a href="http://www.cnblogs.com/xrwang/OtherPosts.html" title="我评论过的随笔列表">我的参与</a></li><li><a href="http://www.cnblogs.com/xrwang/RecentComments.html" title="我的博客的评论列表">最新评论</a></li><li><a href="http://www.cnblogs.com/xrwang/tag/" title="我的博客的标签列表">我的标签</a></li>
</ul>
<div id="itemListLin_con" style="display:none;">
<ul>

</ul>
</div>
</div></div><div id="sidebar_toptags" class="sidebar-block">
<div class="catListTag">
<h3 class="catListTitle">我的标签</h3>
<ul>
<li><a href="http://www.cnblogs.com/xrwang/tag/weixin/">weixin</a>(5)</li><li><a href="http://www.cnblogs.com/xrwang/tag/javascript/">javascript</a>(2)</li><li><a href="http://www.cnblogs.com/xrwang/tag/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/">图像处理</a>(2)</li><li><a href="http://www.cnblogs.com/xrwang/tag/%E9%A2%9C%E8%89%B2/">颜色</a>(1)</li><li><a href="http://www.cnblogs.com/xrwang/tag/%E6%A0%B7%E5%BC%8F%E8%A1%A8/">样式表</a>(1)</li><li><a href="http://www.cnblogs.com/xrwang/tag/js/">js</a>(1)</li><li><a href="http://www.cnblogs.com/xrwang/tag/RANSAC%20%E9%9A%8F%E6%9C%BA%E6%8A%BD%E6%A0%B7%E4%B8%80%E8%87%B4%E6%80%A7%E7%AE%97%E6%B3%95/">RANSAC 随机抽样一致性算法</a>(1)</li><li><a href="http://www.cnblogs.com/xrwang/tag/vbs/">vbs</a>(1)</li><li><a href="http://www.cnblogs.com/xrwang/tag/vs2005/">vs2005</a>(1)</li><li><a href="http://www.cnblogs.com/xrwang/tag/.net%20%E5%9B%BE%E7%89%87%20%E6%AF%94%E8%BE%83/">.net 图片 比较</a>(1)</li><li><a href="http://www.cnblogs.com/xrwang/tag/">更多</a></li>
</ul>
</div></div><div id="sidebar_categories">
<div class="catListPostCategory">
<h3 class="catListTitle">随笔分类<span style="font-size:11px;font-weight:normal">(34)</span></h3>

<ul>

<li><a id="CatList_LinkList_0_Link_0" href="http://www.cnblogs.com/xrwang/category/286522.html">asp.net网站(2)</a> </li>

<li><a id="CatList_LinkList_0_Link_1" href="http://www.cnblogs.com/xrwang/category/575377.html">安卓开发(1)</a> </li>

<li><a id="CatList_LinkList_0_Link_2" href="http://www.cnblogs.com/xrwang/category/303742.html">其他(4)</a> </li>

<li><a id="CatList_LinkList_0_Link_3" href="http://www.cnblogs.com/xrwang/category/286829.html">算法(1)</a> </li>

<li><a id="CatList_LinkList_0_Link_4" href="http://www.cnblogs.com/xrwang/category/231541.html">图像处理(21)</a> </li>

<li><a id="CatList_LinkList_0_Link_5" href="http://www.cnblogs.com/xrwang/category/660918.html">微信(5)</a> </li>

</ul>

</div>

<div class="catListPostArchive">
<h3 class="catListTitle">随笔档案<span style="font-size:11px;font-weight:normal">(40)</span></h3>

<ul>

<li><a id="CatList_LinkList_1_Link_0" href="http://www.cnblogs.com/xrwang/archive/2015/03.html">2015年3月 (3)</a> </li>

<li><a id="CatList_LinkList_1_Link_1" href="http://www.cnblogs.com/xrwang/archive/2015/02.html">2015年2月 (2)</a> </li>

<li><a id="CatList_LinkList_1_Link_2" href="http://www.cnblogs.com/xrwang/archive/2014/05.html">2014年5月 (1)</a> </li>

<li><a id="CatList_LinkList_1_Link_3" href="http://www.cnblogs.com/xrwang/archive/2014/02.html">2014年2月 (1)</a> </li>

<li><a id="CatList_LinkList_1_Link_4" href="http://www.cnblogs.com/xrwang/archive/2013/05.html">2013年5月 (1)</a> </li>

<li><a id="CatList_LinkList_1_Link_5" href="http://www.cnblogs.com/xrwang/archive/2012/06.html">2012年6月 (1)</a> </li>

<li><a id="CatList_LinkList_1_Link_6" href="http://www.cnblogs.com/xrwang/archive/2012/04.html">2012年4月 (1)</a> </li>

<li><a id="CatList_LinkList_1_Link_7" href="http://www.cnblogs.com/xrwang/archive/2011/07.html">2011年7月 (1)</a> </li>

<li><a id="CatList_LinkList_1_Link_8" href="http://www.cnblogs.com/xrwang/archive/2011/06.html">2011年6月 (1)</a> </li>

<li><a id="CatList_LinkList_1_Link_9" href="http://www.cnblogs.com/xrwang/archive/2011/04.html">2011年4月 (1)</a> </li>

<li><a id="CatList_LinkList_1_Link_10" href="http://www.cnblogs.com/xrwang/archive/2011/03.html">2011年3月 (2)</a> </li>

<li><a id="CatList_LinkList_1_Link_11" href="http://www.cnblogs.com/xrwang/archive/2010/12.html">2010年12月 (1)</a> </li>

<li><a id="CatList_LinkList_1_Link_12" href="http://www.cnblogs.com/xrwang/archive/2010/11.html">2010年11月 (1)</a> </li>

<li><a id="CatList_LinkList_1_Link_13" href="http://www.cnblogs.com/xrwang/archive/2010/04.html">2010年4月 (3)</a> </li>

<li><a id="CatList_LinkList_1_Link_14" href="http://www.cnblogs.com/xrwang/archive/2010/03.html">2010年3月 (2)</a> </li>

<li><a id="CatList_LinkList_1_Link_15" href="http://www.cnblogs.com/xrwang/archive/2010/02.html">2010年2月 (7)</a> </li>

<li><a id="CatList_LinkList_1_Link_16" href="http://www.cnblogs.com/xrwang/archive/2010/01.html">2010年1月 (3)</a> </li>

<li><a id="CatList_LinkList_1_Link_17" href="http://www.cnblogs.com/xrwang/archive/2008/09.html">2008年9月 (1)</a> </li>

<li><a id="CatList_LinkList_1_Link_18" href="http://www.cnblogs.com/xrwang/archive/2008/08.html">2008年8月 (3)</a> </li>

<li><a id="CatList_LinkList_1_Link_19" href="http://www.cnblogs.com/xrwang/archive/2008/07.html">2008年7月 (1)</a> </li>

<li><a id="CatList_LinkList_1_Link_20" href="http://www.cnblogs.com/xrwang/archive/2008/01.html">2008年1月 (1)</a> </li>

<li><a id="CatList_LinkList_1_Link_21" href="http://www.cnblogs.com/xrwang/archive/2007/05.html">2007年5月 (1)</a> </li>

<li><a id="CatList_LinkList_1_Link_22" href="http://www.cnblogs.com/xrwang/archive/2007/03.html">2007年3月 (1)</a> </li>

</ul>

</div>

</div><div id="sidebar_recentcomments" class="sidebar-block"><div id="recent_comments_wrap">
<div class="catListComment">
<h3 class="catListTitle">最新评论</h3>
	<div id="RecentCommentsBlock"><ul>
        <li class="recent_comment_title"><a href="http://www.cnblogs.com/xrwang/archive/2010/02/21/ForegroundDetection.html#3624767">1. Re:背景建模与前景检测(Background Generation And Foreground Detection)</a></li>
        <li class="recent_comment_body">感谢楼主无私分享，非常谢谢，比爱心</li>
        <li class="recent_comment_author">--小福贵啦啦</li>
        <li class="recent_comment_title"><a href="http://www.cnblogs.com/xrwang/p/PublicAccount-BasicInterface.html#3582548">2. Re:.net微信公众号开发——基础接口</a></li>
        <li class="recent_comment_body">mark</li>
        <li class="recent_comment_author">--yesorno</li>
        <li class="recent_comment_title"><a href="http://www.cnblogs.com/xrwang/archive/2010/02/05/MatchTemplate.html#3578719">3. Re:模板匹配(Match Template)</a></li>
        <li class="recent_comment_body">博主请问你有这个的源代码吗？有的话，麻烦发一下到我的邮箱1159147833@qq.com，谢谢！</li>
        <li class="recent_comment_author">--zhudada</li>
        <li class="recent_comment_title"><a href="http://www.cnblogs.com/xrwang/archive/2010/03/27/BackgroundGenerationAndForegroundDetectionPhase2.html#3567376">4. Re:背景建模与前景检测之二(Background Generation And Foreground Detection Phase 2)</a></li>
        <li class="recent_comment_body">请问下这个算法实现的源代码有吗？可不可以分享一下？</li>
        <li class="recent_comment_author">--不懂就问的好孩子</li>
        <li class="recent_comment_title"><a href="http://www.cnblogs.com/xrwang/p/PublicAccount-QuickStart.html#3541890">5. Re:.net微信公众号开发——快速入门</a></li>
        <li class="recent_comment_body">有没有人遇到，开启服务器安全狗后回话验证中级模式后，消息返回不了的问题的？<br></li>
        <li class="recent_comment_author">--dfjjfxyl</li>
</ul>
</div>
</div>
</div></div><div id="sidebar_topviewedposts" class="sidebar-block"><div id="topview_posts_wrap">
<div class="catListView">
<h3 class="catListTitle">阅读排行榜</h3>
	<div id="TopViewPostsBlock"><ul><li><a href="http://www.cnblogs.com/xrwang/p/AndroidStudioImportJarAndSoLibrary.html">1. Android Studio开发入门-引用jar及so文件(91646)</a></li><li><a href="http://www.cnblogs.com/xrwang/archive/2010/03/03/ImageFeatureDetection.html">2. 图像特征检测(Image Feature Detection)(53477)</a></li><li><a href="http://www.cnblogs.com/xrwang/archive/2010/02/05/MatchTemplate.html">3. 模板匹配(Match Template)(50764)</a></li><li><a href="http://www.cnblogs.com/xrwang/archive/2010/02/28/ImageSegmentation.html">4. 图像分割(Image Segmentation)(46472)</a></li><li><a href="http://www.cnblogs.com/xrwang/archive/2011/03/09/ransac-1.html">5. 随机抽样一致性算法（RANSAC）(40694)</a></li></ul></div>
</div>
</div></div><div id="sidebar_topcommentedposts" class="sidebar-block"><div id="topfeedback_posts_wrap">
<div class="catListFeedback">
<h3 class="catListTitle">评论排行榜</h3>
	<div id="TopFeedbackPostsBlock"><ul><li><a href="http://www.cnblogs.com/xrwang/archive/2010/03/03/ImageFeatureDetection.html">1. 图像特征检测(Image Feature Detection)(108)</a></li><li><a href="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园.html">2. 背景建模与前景检测(Background Generation And Foreground Detection)(61)</a></li><li><a href="http://www.cnblogs.com/xrwang/archive/2010/02/04/HowToUseHistogram.html">3. 颜色直方图的计算、显示、处理、对比及反向投影(How to Use Histogram? Calculate, Show, Process, Compare and BackProject)(58)</a></li><li><a href="http://www.cnblogs.com/xrwang/archive/2010/12/20/SourceCode.html">4. 源代码下载(53)</a></li><li><a href="http://www.cnblogs.com/xrwang/archive/2010/04/27/GrabCut.html">5. OpenCV(EmguCV)2.1新特性介绍之图像分割GrabCut(GrabCut Of OpenCV 2.1)(51)</a></li></ul></div>
</div>
</div></div><div id="sidebar_topdiggedposts" class="sidebar-block"><div id="topdigg_posts_wrap">
<div class="catListView">
<h3 class="catListTitle">推荐排行榜</h3>
<div id="TopDiggPostsBlock"><ul><li><a href="http://www.cnblogs.com/xrwang/archive/2010/03/03/ImageFeatureDetection.html">1. 图像特征检测(Image Feature Detection)(29)</a></li><li><a href="./背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园_files/背景建模与前景检测(Background Generation And Foreground Detection) - Wuya - 博客园.html">2. 背景建模与前景检测(Background Generation And Foreground Detection)(19)</a></li><li><a href="http://www.cnblogs.com/xrwang/archive/2010/02/09/HowToUseContour.html">3. 轮廓的查找、表达、绘制、特性及匹配(How to Use Contour? Find, Component, Construct, Features &amp; Match)(15)</a></li><li><a href="http://www.cnblogs.com/xrwang/archive/2010/01/26/TheComparisonOfImageProcessingLibraries.html">4. 各种图像处理类库的比较及选择(The Comparison of Image Processing Libraries)(15)</a></li><li><a href="http://www.cnblogs.com/xrwang/p/PublicAccount-QuickStart.html">5. .net微信公众号开发——快速入门(14)</a></li></ul></div>
</div></div></div></div><script type="text/javascript">loadBlogSideColumn();</script>
			</div>
			
		</div><!--end: sideBarMain -->
	</div><!--end: sideBar 侧边栏容器 -->
	<div class="clear"></div>
	</div><!--end: main -->
	<div class="clear"></div>
	<div id="footer">
		
<!--done-->
Copyright ©2017 Wuya
	</div><!--end: footer -->
</div><!--end: home 自定义的最大容器 -->


</body></html>